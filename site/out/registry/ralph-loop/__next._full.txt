1:"$Sreact.fragment"
2:I[63880,["/agent-utils/_next/static/chunks/e57f8bd634e3e83c.js","/agent-utils/_next/static/chunks/152d0cd9196fc828.js"],"default"]
3:I[93744,["/agent-utils/_next/static/chunks/e57f8bd634e3e83c.js","/agent-utils/_next/static/chunks/152d0cd9196fc828.js"],"default"]
5:I[71831,["/agent-utils/_next/static/chunks/e57f8bd634e3e83c.js","/agent-utils/_next/static/chunks/152d0cd9196fc828.js"],"OutletBoundary"]
6:"$Sreact.suspense"
8:I[71831,["/agent-utils/_next/static/chunks/e57f8bd634e3e83c.js","/agent-utils/_next/static/chunks/152d0cd9196fc828.js"],"ViewportBoundary"]
a:I[71831,["/agent-utils/_next/static/chunks/e57f8bd634e3e83c.js","/agent-utils/_next/static/chunks/152d0cd9196fc828.js"],"MetadataBoundary"]
c:I[78227,[],"default"]
:HL["/agent-utils/_next/static/chunks/1ccc4ed0039644ae.css","style"]
:HL["/agent-utils/_next/static/media/0c89a48fa5027cee-s.p.4564287c.woff2","font",{"crossOrigin":"","type":"font/woff2"}]
:HL["/agent-utils/_next/static/media/70bc3e132a0a741e-s.p.15008bfb.woff2","font",{"crossOrigin":"","type":"font/woff2"}]
:HL["/agent-utils/_next/static/chunks/1cc242b844a8c0ef.css","style"]
0:{"P":null,"b":"V-lmlVXDbgn8jLUnd3qGh","c":["","registry","ralph-loop",""],"q":"","i":false,"f":[[["",{"children":["registry",{"children":[["concept","ralph-loop","d"],{"children":["__PAGE__",{}]}]}]},"$undefined","$undefined",true],[["$","$1","c",{"children":[[["$","link","0",{"rel":"stylesheet","href":"/agent-utils/_next/static/chunks/1ccc4ed0039644ae.css","precedence":"next","crossOrigin":"$undefined","nonce":"$undefined"}]],["$","html",null,{"lang":"en","className":"h-full","children":["$","body",null,{"className":"space_grotesk_a4177b3f-module__DCxVEW__variable jetbrains_mono_2b1eae20-module__XfFTLG__variable min-h-full font-sans","children":["$","$L2",null,{"parallelRouterKey":"children","error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L3",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":[[["$","title",null,{"children":"404: This page could not be found."}],["$","div",null,{"style":{"fontFamily":"system-ui,\"Segoe UI\",Roboto,Helvetica,Arial,sans-serif,\"Apple Color Emoji\",\"Segoe UI Emoji\"","height":"100vh","textAlign":"center","display":"flex","flexDirection":"column","alignItems":"center","justifyContent":"center"},"children":["$","div",null,{"children":[["$","style",null,{"dangerouslySetInnerHTML":{"__html":"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}"}}],["$","h1",null,{"className":"next-error-h1","style":{"display":"inline-block","margin":"0 20px 0 0","padding":"0 23px 0 0","fontSize":24,"fontWeight":500,"verticalAlign":"top","lineHeight":"49px"},"children":404}],["$","div",null,{"style":{"display":"inline-block"},"children":["$","h2",null,{"style":{"fontSize":14,"fontWeight":400,"lineHeight":"49px","margin":0},"children":"This page could not be found."}]}]]}]}]],[]],"forbidden":"$undefined","unauthorized":"$undefined"}]}]}]]}],{"children":[["$","$1","c",{"children":[null,["$","$L2",null,{"parallelRouterKey":"children","error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L3",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","forbidden":"$undefined","unauthorized":"$undefined"}]]}],{"children":[["$","$1","c",{"children":[null,["$","$L2",null,{"parallelRouterKey":"children","error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L3",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","forbidden":"$undefined","unauthorized":"$undefined"}]]}],{"children":[["$","$1","c",{"children":["$L4",[["$","link","0",{"rel":"stylesheet","href":"/agent-utils/_next/static/chunks/1cc242b844a8c0ef.css","precedence":"next","crossOrigin":"$undefined","nonce":"$undefined"}],["$","script","script-0",{"src":"/agent-utils/_next/static/chunks/88049d1610f79db3.js","async":true,"nonce":"$undefined"}],["$","script","script-1",{"src":"/agent-utils/_next/static/chunks/122bbe670a0c62fe.js","async":true,"nonce":"$undefined"}],["$","script","script-2",{"src":"/agent-utils/_next/static/chunks/28ac2bf59af5b750.js","async":true,"nonce":"$undefined"}]],["$","$L5",null,{"children":["$","$6",null,{"name":"Next.MetadataOutlet","children":"$@7"}]}]]}],{},null,false,false]},null,false,false]},null,false,false]},null,false,false],["$","$1","h",{"children":[null,["$","$L8",null,{"children":"$@9"}],["$","div",null,{"hidden":true,"children":["$","$La",null,{"children":["$","$6",null,{"name":"Next.Metadata","children":"$@b"}]}]}],["$","meta",null,{"name":"next-size-adjust","content":""}]]}],false]],"m":"$undefined","G":["$c",[]],"s":false,"S":true}
9:[["$","meta","0",{"charSet":"utf-8"}],["$","meta","1",{"name":"viewport","content":"width=device-width, initial-scale=1"}]]
d:I[27130,["/agent-utils/_next/static/chunks/88049d1610f79db3.js","/agent-utils/_next/static/chunks/122bbe670a0c62fe.js","/agent-utils/_next/static/chunks/28ac2bf59af5b750.js"],""]
4:["$","main",null,{"className":"min-h-screen bg-background","children":["$","div",null,{"className":"relative","children":[["$","div",null,{"className":"pointer-events-none absolute inset-0 overflow-hidden","children":[["$","div",null,{"className":"absolute -left-24 top-16 h-64 w-64 rounded-full bg-orange-200/30 blur-3xl"}],["$","div",null,{"className":"absolute right-[-120px] top-40 h-72 w-72 rounded-full bg-cyan-200/30 blur-3xl"}],["$","div",null,{"className":"absolute inset-0 bg-[linear-gradient(to_right,rgba(15,23,42,0.06)_1px,transparent_1px),linear-gradient(to_bottom,rgba(15,23,42,0.06)_1px,transparent_1px)] bg-[size:72px_72px] opacity-40"}]]}],["$","header",null,{"className":"sticky top-0 z-30 border-b border-border/60 bg-background/80 backdrop-blur","children":["$","div",null,{"className":"flex w-full items-center gap-6 px-4 py-3 sm:px-6 xl:px-10","children":[["$","$Ld",null,{"href":"/","className":"flex items-center gap-3","children":[["$","div",null,{"className":"flex h-10 w-10 items-center justify-center rounded-xl bg-slate-900 text-white shadow-sm","children":"AU"}],["$","div",null,{"className":"hidden sm:flex flex-col","children":["$","span",null,{"className":"text-xs font-semibold uppercase tracking-[0.24em] text-slate-600","children":"Agent Utils"}]}]]}],["$","nav",null,{"className":"hidden lg:flex items-center gap-4 text-sm font-medium text-muted-foreground","children":[["$","$Ld",null,{"href":"/","className":"hover:text-foreground","children":"Home"}],["$","$Ld",null,{"href":"/registry","className":"hover:text-foreground","children":"Registry"}]]}],["$","div",null,{"className":"ml-auto flex items-center gap-2","children":[["$","a",null,{"href":"https://github.com/brennanmceachran/agent-utils","target":"_blank","rel":"noreferrer","children":"GitHub","className":"items-center justify-center gap-2 rounded-lg text-sm font-semibold tracking-tight transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 ring-offset-background border border-border/70 bg-transparent text-foreground hover:bg-muted/70 h-11 px-5 py-2.5 hidden sm:inline-flex","ref":null}],["$","$Ld",null,{"href":"/registry","children":"Browse registry","className":"inline-flex items-center justify-center gap-2 rounded-lg text-sm font-semibold tracking-tight transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 ring-offset-background border border-border/70 bg-secondary text-secondary-foreground shadow-sm hover:bg-secondary/70 h-11 px-5 py-2.5","ref":null}]]}]]}]}],["$","div",null,{"className":"relative w-full px-4 pb-16 pt-6 sm:px-6 xl:px-10","children":["$","div",null,{"className":"mt-6 grid gap-8 lg:grid-cols-[minmax(200px,240px)_minmax(0,720px)_minmax(0,1fr)] xl:grid-cols-[minmax(240px,1fr)_minmax(0,760px)_minmax(240px,1fr)]","children":[["$","aside",null,{"className":"hidden lg:flex lg:flex-col lg:sticky lg:top-20 lg:h-[calc(100vh-6rem)] lg:justify-self-start lg:overflow-y-auto lg:pr-2","children":["$","div",null,{"className":"space-y-6","children":["$","div",null,{"className":"space-y-2","children":[["$","p",null,{"className":"text-xs font-semibold uppercase tracking-[0.24em] text-muted-foreground","children":"Registry"}],["$","nav",null,{"className":"space-y-1","children":[["$","$Ld","nextjs-mcp",{"href":"/registry/nextjs-mcp","aria-current":"$undefined","className":"flex items-center justify-between rounded-xl px-3 py-2 text-sm font-medium transition text-muted-foreground hover:bg-muted/60 hover:text-foreground","children":["$","span",null,{"children":"Next.js MCP"}]}],["$","$Ld","ralph-loop",{"href":"/registry/ralph-loop","aria-current":"page","className":"flex items-center justify-between rounded-xl px-3 py-2 text-sm font-medium transition bg-foreground text-background shadow-sm","children":"$Le"}],"$Lf"]}]]}]}]}],"$L10","$L11"]}]}]]}]}]
13:I[27655,["/agent-utils/_next/static/chunks/88049d1610f79db3.js","/agent-utils/_next/static/chunks/122bbe670a0c62fe.js","/agent-utils/_next/static/chunks/28ac2bf59af5b750.js"],"PlatformTabs"]
e:["$","span",null,{"children":"Ralph Loop"}]
f:["$","$Ld","webresearch",{"href":"/registry/webresearch","aria-current":"$undefined","className":"flex items-center justify-between rounded-xl px-3 py-2 text-sm font-medium transition text-muted-foreground hover:bg-muted/60 hover:text-foreground","children":["$","span",null,{"children":"Web Research"}]}]
14:T8b9,---
description: Ralph loop agent (autonomous iterations)
mode: primary
permission:
  bash:
    'git push': deny
    '*': allow
  external_directory: deny
  doom_loop: allow
---

You are the Ralph Loop Code agent.

Control messages:

- If you receive a message containing `RALPH_CONTROL:`, treat it as plugin control. Reply with a brief acknowledgement only (no tool calls) and wait for the next iteration prompt. Outside of that you are expected to begin coding.

Ralph loop mechanics:

- Each iteration will include a `<task_prompt_file>` block containing the user-authored prompt file. Treat that as the source of truth for WHAT to do.
- In each iteration, pick the single most useful next step you can complete now FROM the mentioned prompt file:
  - CODE THAT TASK in the code base. Keep going until you hit a blocker or the task is done. You may not ask the user questions, it's assumed all necessary context is in the prompt file.
  - Once done, update the prompt file with your progress so the next iteration can continue.
- The prompt file is durable memory. Keep it concise and current with progress, decisions, and next steps (chat history may be compacted).
- Once your turn is over, you will be summoned again automatically with the same prompt file. Continue working where you left off. Do not wait for the user.

Rules:

- Stay inside this repo/worktree. Do not read/write/edit files outside the repo.
- Never delete or rename the prompt file.
- Never run `git push`.
- Avoid catastrophic commands (e.g. repo wipes like `rm -rf .` / `rm -rf *`, disk wipes like `rm -rf /` or `rm -rf ~`).

Working style:

- Use `## Acceptance Criteria` to define "done"; use `## Verification` to prove it.
- Keep changes small and verify frequently.
- Update `## Progress` every iteration with: what changed, current status, next step, and any verification results/errors.
- If a command is blocked/denied, do not retry it. Choose a safer alternative and note it in `## Progress`.
- If stuck, log the blocker and what you tried in `## Progress`, then attempt the next best approach.

Completion:

- Only when the task is fully complete AND verification passes, end your final message with the exact token `RALPH_DONE` on its own line.
15:T1bd4,<pre class="shiki vitesse-light" style="background-color:#ffffff;color:#393a34" tabindex="0"><code><span class="line"><span style="color:#005CC5;font-weight:bold">---</span></span>
<span class="line"><span style="color:#393A34">description: Ralph loop agent (autonomous iterations)</span></span>
<span class="line"><span style="color:#393A34">mode: primary</span></span>
<span class="line"><span style="color:#393A34">permission:</span></span>
<span class="line"><span style="color:#393A34">  bash:</span></span>
<span class="line"><span style="color:#393A34">    'git push': deny</span></span>
<span class="line"><span style="color:#393A34">    '*': allow</span></span>
<span class="line"><span style="color:#393A34">  external_directory: deny</span></span>
<span class="line"><span style="color:#393A34">  doom_loop: allow</span></span>
<span class="line"><span style="color:#1C6B48;font-weight:bold">---</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34">You are the Ralph Loop Code agent.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34">Control messages:</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A65E2B">-</span><span style="color:#393A34"> If you receive a message containing </span><span style="color:#999999">`</span><span style="color:#393A34">RALPH_CONTROL:</span><span style="color:#999999">`</span><span style="color:#393A34">, treat it as plugin control. Reply with a brief acknowledgement only (no tool calls) and wait for the next iteration prompt. Outside of that you are expected to begin coding.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34">Ralph loop mechanics:</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A65E2B">-</span><span style="color:#393A34"> Each iteration will include a </span><span style="color:#999999">`</span><span style="color:#393A34">&#x3C;task_prompt_file></span><span style="color:#999999">`</span><span style="color:#393A34"> block containing the user-authored prompt file. Treat that as the source of truth for WHAT to do.</span></span>
<span class="line"><span style="color:#A65E2B">-</span><span style="color:#393A34"> In each iteration, pick the single most useful next step you can complete now FROM the mentioned prompt file:</span></span>
<span class="line"><span style="color:#A65E2B">  -</span><span style="color:#393A34"> CODE THAT TASK in the code base. Keep going until you hit a blocker or the task is done. You may not ask the user questions, it's assumed all necessary context is in the prompt file.</span></span>
<span class="line"><span style="color:#A65E2B">  -</span><span style="color:#393A34"> Once done, update the prompt file with your progress so the next iteration can continue.</span></span>
<span class="line"><span style="color:#A65E2B">-</span><span style="color:#393A34"> The prompt file is durable memory. Keep it concise and current with progress, decisions, and next steps (chat history may be compacted).</span></span>
<span class="line"><span style="color:#A65E2B">-</span><span style="color:#393A34"> Once your turn is over, you will be summoned again automatically with the same prompt file. Continue working where you left off. Do not wait for the user.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34">Rules:</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A65E2B">-</span><span style="color:#393A34"> Stay inside this repo/worktree. Do not read/write/edit files outside the repo.</span></span>
<span class="line"><span style="color:#A65E2B">-</span><span style="color:#393A34"> Never delete or rename the prompt file.</span></span>
<span class="line"><span style="color:#A65E2B">-</span><span style="color:#393A34"> Never run </span><span style="color:#999999">`</span><span style="color:#393A34">git push</span><span style="color:#999999">`</span><span style="color:#393A34">.</span></span>
<span class="line"><span style="color:#A65E2B">-</span><span style="color:#393A34"> Avoid catastrophic commands (e.g. repo wipes like </span><span style="color:#999999">`</span><span style="color:#393A34">rm -rf .</span><span style="color:#999999">`</span><span style="color:#393A34"> / </span><span style="color:#999999">`</span><span style="color:#393A34">rm -rf *</span><span style="color:#999999">`</span><span style="color:#393A34">, disk wipes like </span><span style="color:#999999">`</span><span style="color:#393A34">rm -rf /</span><span style="color:#999999">`</span><span style="color:#393A34"> or </span><span style="color:#999999">`</span><span style="color:#393A34">rm -rf ~</span><span style="color:#999999">`</span><span style="color:#393A34">).</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34">Working style:</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A65E2B">-</span><span style="color:#393A34"> Use </span><span style="color:#999999">`</span><span style="color:#393A34">## Acceptance Criteria</span><span style="color:#999999">`</span><span style="color:#393A34"> to define "done"; use </span><span style="color:#999999">`</span><span style="color:#393A34">## Verification</span><span style="color:#999999">`</span><span style="color:#393A34"> to prove it.</span></span>
<span class="line"><span style="color:#A65E2B">-</span><span style="color:#393A34"> Keep changes small and verify frequently.</span></span>
<span class="line"><span style="color:#A65E2B">-</span><span style="color:#393A34"> Update </span><span style="color:#999999">`</span><span style="color:#393A34">## Progress</span><span style="color:#999999">`</span><span style="color:#393A34"> every iteration with: what changed, current status, next step, and any verification results/errors.</span></span>
<span class="line"><span style="color:#A65E2B">-</span><span style="color:#393A34"> If a command is blocked/denied, do not retry it. Choose a safer alternative and note it in </span><span style="color:#999999">`</span><span style="color:#393A34">## Progress</span><span style="color:#999999">`</span><span style="color:#393A34">.</span></span>
<span class="line"><span style="color:#A65E2B">-</span><span style="color:#393A34"> If stuck, log the blocker and what you tried in </span><span style="color:#999999">`</span><span style="color:#393A34">## Progress</span><span style="color:#999999">`</span><span style="color:#393A34">, then attempt the next best approach.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34">Completion:</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A65E2B">-</span><span style="color:#393A34"> Only when the task is fully complete AND verification passes, end your final message with the exact token </span><span style="color:#999999">`</span><span style="color:#393A34">RALPH_DONE</span><span style="color:#999999">`</span><span style="color:#393A34"> on its own line.</span></span>
<span class="line"></span></code></pre>16:T76f,<pre class="shiki vitesse-light" style="background-color:#ffffff;color:#393a34" tabindex="0"><code><span class="line"><span style="color:#005CC5;font-weight:bold">---</span></span>
<span class="line"><span style="color:#393A34">description: Start/stop a Ralph loop on a prompt file</span></span>
<span class="line"><span style="color:#393A34">agent: ralph</span></span>
<span class="line"><span style="color:#1C6B48;font-weight:bold">---</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34">RALPH_CONTROL: {"arg1":"$1","arg2":"$2","arg3":"$3"}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34">This command sends a control message that the Ralph loop plugin listens for.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A65E2B">-</span><span style="color:#393A34"> If </span><span style="color:#999999">`</span><span style="color:#393A34">$1</span><span style="color:#999999">`</span><span style="color:#393A34"> is </span><span style="color:#999999">`</span><span style="color:#393A34">stop</span><span style="color:#999999">`</span><span style="color:#393A34">, stop the Ralph loop.</span></span>
<span class="line"><span style="color:#A65E2B">-</span><span style="color:#393A34"> Otherwise, treat </span><span style="color:#999999">`</span><span style="color:#393A34">$1</span><span style="color:#999999">`</span><span style="color:#393A34"> as the prompt file reference and </span><span style="color:#999999">`</span><span style="color:#393A34">$2</span><span style="color:#999999">`</span><span style="color:#393A34"> as an optional max-iterations number.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#393A34">Respond with a brief acknowledgement only. Do not run tools in response to this control message.</span></span>
<span class="line"></span></code></pre>17:T2e14,/// <reference path="../types/shims.d.ts" />

import fs from "node:fs/promises";
import path from "node:path";
import type { Plugin } from "@opencode-ai/plugin";

import {
  CONTROL_PREFIX,
  DEFAULT_MAX_ITERATIONS,
  DONE_TOKEN,
  hasDone,
  isPathInside,
  lintPrompt,
  loadJson,
  normalizeRelToken,
  parseControl,
  rmTargetsFromArgs,
  saveJson,
  splitShellSegments,
  stripArg,
  stripEnvPrefixes,
  textFromParts,
  tokenize,
} from "../ralph/ralph-utils";

type RalphSession = {
  enabled: boolean;
  promptPath: string; // repo-relative
  maxIterations: number;
  iteration: number;
};

type RalphState = {
  version: 1;
  sessions: Record<string, RalphSession>;
};

type ChatMessageInput = {
  sessionID: string;
};

type ChatMessageOutput = {
  parts: unknown[];
};

type SessionMessage = {
  info?: {
    role?: string;
  };
  parts?: unknown[];
};

type SessionMessagesResponse = {
  data?: SessionMessage[];
};

type IdleEvent = {
  type: string;
  properties: {
    sessionID: string;
  };
};

type IdleEventInput = {
  event: IdleEvent;
};

type ToolExecuteInput = {
  sessionID: string;
  tool: string;
};

type ToolExecuteOutput = {
  args?: {
    command?: string;
    filePath?: string;
  };
};

export const RalphLoopPlugin: Plugin = async ({ client, worktree }) => {
  const stateFile = path.join(worktree, ".opencode", "ralph", "state.json");
  const state = await loadJson<RalphState>(stateFile, { version: 1, sessions: {} });

  const toast = async (
    message: string,
    variant: "info" | "success" | "warning" | "error" = "info",
  ): Promise<void> => {
    await client.tui.showToast({ body: { title: "Ralph", message, variant } });
  };

  const persist = () => saveJson(stateFile, state);

  const stop = async (sessionID: string, reason: string) => {
    const s = state.sessions?.[sessionID];
    if (!s?.enabled) return;
    s.enabled = false;
    await persist();
    await toast(`Stopped: ${reason}`, "warning");
  };

  const start = async (sessionID: string, promptArg: string, maxArg?: string) => {
    const raw = stripArg(promptArg);
    const abs = path.isAbsolute(raw) ? raw : path.resolve(worktree, raw);

    let real = abs;
    try {
      real = await fs.realpath(abs);
    } catch {
      // ignore
    }

    if (!isPathInside(worktree, real)) {
      await toast(`Refusing to start: prompt file is outside repo (${promptArg})`, "error");
      return;
    }

    try {
      if (!(await fs.stat(real)).isFile()) throw new Error("not file");
    } catch {
      await toast(`Refusing to start: prompt file not found (${promptArg})`, "error");
      return;
    }

    const md = await fs.readFile(real, "utf8");
    const lintErrors = lintPrompt(md);
    if (lintErrors.length) {
      await toast(`Prompt file lint failed:\n- ${lintErrors.join("\n- ")}`, "error");
      return;
    }

    const maxIterations =
      maxArg && /^[0-9]+$/.test(String(maxArg)) ? Number(maxArg) : DEFAULT_MAX_ITERATIONS;
    state.sessions[sessionID] = {
      enabled: true,
      promptPath: path.relative(worktree, real),
      maxIterations,
      iteration: 0,
    };

    await persist();
    await toast(
      `Enabled (max ${maxIterations}) using ${state.sessions[sessionID].promptPath}`,
      "success",
    );
  };

  const guardBash = (command: string, session: RalphSession) => {
    const cmd = String(command ?? "").trim();
    if (!cmd) return;

    const worktreeAbs = path.resolve(worktree);
    const promptAbs = path.resolve(worktreeAbs, session.promptPath);
    const promptRel = normalizeRelToken(session.promptPath);

    let simulatedCwd = worktreeAbs;

    const assertInside = (absPath: string, operation: string) => {
      if (!isPathInside(worktreeAbs, absPath)) {
        throw new Error(`Ralph safety: refusing to ${operation} outside repo`);
      }
    };

    const resolveFromCwd = (maybePath: string) =>
      path.isAbsolute(maybePath) ? path.resolve(maybePath) : path.resolve(simulatedCwd, maybePath);

    for (const seg of splitShellSegments(cmd)) {
      const tokens = stripEnvPrefixes(tokenize(seg));
      const a = tokens[0] ?? "";
      const b = tokens[1] ?? "";
      if (!a) continue;

      // Track `cd` so relative destructive ops resolve correctly.
      if (a === "cd") {
        const dest = tokens[1];
        if (!dest || dest === "-") throw new Error("Ralph safety: refusing ambiguous cd");

        if (/[`$]/.test(String(dest))) {
          throw new Error("Ralph safety: refusing non-literal cd target");
        }

        const normalized = normalizeRelToken(String(dest));
        if (
          normalized.startsWith("~") ||
          normalized.startsWith("$HOME") ||
          normalized.startsWith("${HOME}")
        ) {
          throw new Error("Ralph safety: refusing cd to home paths");
        }

        const next = resolveFromCwd(String(dest));
        assertInside(next, "cd");
        simulatedCwd = next;
        continue;
      }

      if (a === "sudo") throw new Error("Ralph safety: sudo is disabled");
      if (a === "git" && b === "push") throw new Error("Ralph safety: git push is disabled");
      if (a === "git" && b === "clean" && tokens.some((t) => String(t).includes("-f"))) {
        throw new Error("Ralph safety: git clean with -f is disabled");
      }

      const isRm = a === "rm" || a === "rmdir";
      const isGitRm = a === "git" && b === "rm";
      const isMv = a === "mv";
      const isGitMv = a === "git" && b === "mv";

      // Prevent prompt file moves/renames (and prevent moving files outside repo).
      if (isMv || isGitMv) {
        const offset = isGitMv ? 2 : 1;
        const paths = rmTargetsFromArgs(tokens.slice(offset));
        for (const rawTok of paths) {
          const raw = String(rawTok);
          if (/[`$]/.test(raw)) throw new Error("Ralph safety: refusing non-literal mv path");
          const abs = resolveFromCwd(raw);
          if (abs === promptAbs)
            throw new Error("Ralph safety: cannot move/rename the prompt file");
          assertInside(abs, "move files");
        }
        continue;
      }

      if (!isRm && !isGitRm) continue;

      const offset = isGitRm ? 2 : 1;
      const targets = rmTargetsFromArgs(tokens.slice(offset));

      for (const rawTok of targets) {
        const raw = String(rawTok);
        if (/[`$]/.test(raw)) throw new Error("Ralph safety: refusing non-literal rm target");
        const normalizedForWipe = normalizeRelToken(raw).replace(/\/+$/, "");

        // Block the classic "oops" wipes.
        if (normalizedForWipe === "" || normalizedForWipe === "." || normalizedForWipe === "*") {
          throw new Error("Ralph safety: refusing repo wipe");
        }

        if (raw === "/" || raw === "/*") throw new Error("Ralph safety: refusing disk wipe");

        if (
          normalizedForWipe.startsWith("~") ||
          normalizedForWipe.startsWith("$HOME") ||
          normalizedForWipe.startsWith("${HOME}")
        ) {
          throw new Error("Ralph safety: refusing home paths");
        }

        // Protect the prompt file.
        if (normalizedForWipe === promptRel) {
          throw new Error("Ralph safety: cannot delete the prompt file");
        }

        const abs = resolveFromCwd(raw);
        if (abs === promptAbs) throw new Error("Ralph safety: cannot delete the prompt file");
        if (abs === worktreeAbs) throw new Error("Ralph safety: refusing to delete repo root");

        assertInside(abs, "delete files");
      }
    }
  };

  const runIteration = async (sessionID: string, session: RalphSession) => {
    if (session.iteration >= session.maxIterations) {
      await stop(sessionID, `max iterations reached (${session.maxIterations})`);
      return;
    }

    const promptReal = path.join(worktree, session.promptPath);
    const promptContents = await fs.readFile(promptReal, "utf8");

    session.iteration += 1;
    await persist();
    await toast(`Iteration ${session.iteration}/${session.maxIterations}`, "info");

    const msg = [
      `<ralph_iteration number="${session.iteration}" max="${session.maxIterations}">`,
      "<ralph_rules>",
      "- Task spec: follow the content in <task_prompt_file>.",
      "- Read `## Progress` as you may have already started coding and done some work.",
      "- Focus: pick the single most useful next step you can complete now.",
      "- Make concrete progress in implementing the features/functionality described in that doc. Do this by coding in this repo/working directory.",
      "- Once you are done, update the prompt file, especially `## Progress`, to be accurate with your progress so far.",
      "- In `## Progress`, record: what you changed, current status, next step, and any verification results/errors.",
      "- Keep the prompt file concise and current; it is durable memory (chat may be compacted).",
      "- Use ## Acceptance Criteria to define done; use ## Verification to prove it.",
      "- If a command is blocked/denied, do not retry it; choose a safer alternative and note it in ## Progress.",
      "- If stuck, log the blocker and what you tried in ## Progress, then attempt the next best approach.",
      `- Completion: only when fully complete and verified, end your final message with a line containing only: ${DONE_TOKEN}`,
      "</ralph_rules>",
      `<task_prompt_file path="${session.promptPath}">`,
      promptContents,
      "</task_prompt_file>",
      "</ralph_iteration>",
    ].join("\n");

    await client.session.prompt({
      path: { id: sessionID },
      body: { agent: "ralph", parts: [{ type: "text", text: msg }] },
    });
  };

  return {
    "chat.message": async (input: ChatMessageInput, output: ChatMessageOutput) => {
      const text = textFromParts(output.parts);
      if (!text.includes(CONTROL_PREFIX)) return;

      const control = parseControl(text);
      if (!control) return toast("Could not parse RALPH_CONTROL JSON", "error");

      const arg1 = String(control.arg1 ?? "").trim();
      const arg2 = String(control.arg2 ?? "").trim();

      if (!arg1) return toast("Usage: /ralph @prompt.md [max]  OR  /ralph stop", "error");
      if (arg1 === "stop") return stop(input.sessionID, "manual stop");

      return start(input.sessionID, arg1, arg2);
    },

    event: async ({ event }: IdleEventInput) => {
      if (event.type !== "session.idle") return;
      const sessionID = event.properties.sessionID;
      const session = state.sessions?.[sessionID];
      if (!session?.enabled) return;

      try {
        const messagesResult = (await client.session.messages({
          path: { id: sessionID },
          query: { limit: 25 },
        })) as SessionMessagesResponse;
        const messages = messagesResult.data ?? [];
        const lastAssistant = [...messages].reverse().find((m) => m.info?.role === "assistant");
        if (lastAssistant && hasDone(textFromParts(lastAssistant.parts ?? [])))
          return stop(sessionID, DONE_TOKEN);
      } catch {
        // ignore
      }

      return runIteration(sessionID, session);
    },

    "tool.execute.before": async (input: ToolExecuteInput, output: ToolExecuteOutput) => {
      const session = state.sessions?.[input.sessionID];
      if (!session?.enabled) return;

      if (input.tool === "bash") {
        guardBash(output.args?.command, session);
        return;
      }

      if (input.tool === "read" || input.tool === "write" || input.tool === "edit") {
        const filePath = output.args?.filePath;
        if (typeof filePath !== "string" || !filePath) return;
        const abs = path.isAbsolute(filePath) ? filePath : path.resolve(worktree, filePath);
        if (!isPathInside(worktree, abs))
          throw new Error("Ralph safety: file access outside repo is disabled");
      }
    },
  };
};
18:T175d9,<pre class="shiki vitesse-light" style="background-color:#ffffff;color:#393a34" tabindex="0"><code><span class="line"><span style="color:#A0ADA0">/// </span><span style="color:#999999">&#x3C;</span><span style="color:#1E754F">reference</span><span style="color:#B07D48"> path</span><span style="color:#999999">=</span><span style="color:#B5695977">"</span><span style="color:#B56959">../types/shims.d.ts</span><span style="color:#B5695977">"</span><span style="color:#999999"> /></span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F">import</span><span style="color:#B07D48"> fs</span><span style="color:#1E754F"> from</span><span style="color:#B5695977"> "</span><span style="color:#B56959">node:fs/promises</span><span style="color:#B5695977">"</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#1E754F">import</span><span style="color:#B07D48"> path</span><span style="color:#1E754F"> from</span><span style="color:#B5695977"> "</span><span style="color:#B56959">node:path</span><span style="color:#B5695977">"</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#1E754F">import</span><span style="color:#1E754F"> type</span><span style="color:#999999"> {</span><span style="color:#B07D48"> Plugin</span><span style="color:#999999"> }</span><span style="color:#1E754F"> from</span><span style="color:#B5695977"> "</span><span style="color:#B56959">@opencode-ai/plugin</span><span style="color:#B5695977">"</span><span style="color:#999999">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F">import</span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#B07D48">  CONTROL_PREFIX</span><span style="color:#999999">,</span></span>
<span class="line"><span style="color:#B07D48">  DEFAULT_MAX_ITERATIONS</span><span style="color:#999999">,</span></span>
<span class="line"><span style="color:#B07D48">  DONE_TOKEN</span><span style="color:#999999">,</span></span>
<span class="line"><span style="color:#B07D48">  hasDone</span><span style="color:#999999">,</span></span>
<span class="line"><span style="color:#B07D48">  isPathInside</span><span style="color:#999999">,</span></span>
<span class="line"><span style="color:#B07D48">  lintPrompt</span><span style="color:#999999">,</span></span>
<span class="line"><span style="color:#B07D48">  loadJson</span><span style="color:#999999">,</span></span>
<span class="line"><span style="color:#B07D48">  normalizeRelToken</span><span style="color:#999999">,</span></span>
<span class="line"><span style="color:#B07D48">  parseControl</span><span style="color:#999999">,</span></span>
<span class="line"><span style="color:#B07D48">  rmTargetsFromArgs</span><span style="color:#999999">,</span></span>
<span class="line"><span style="color:#B07D48">  saveJson</span><span style="color:#999999">,</span></span>
<span class="line"><span style="color:#B07D48">  splitShellSegments</span><span style="color:#999999">,</span></span>
<span class="line"><span style="color:#B07D48">  stripArg</span><span style="color:#999999">,</span></span>
<span class="line"><span style="color:#B07D48">  stripEnvPrefixes</span><span style="color:#999999">,</span></span>
<span class="line"><span style="color:#B07D48">  textFromParts</span><span style="color:#999999">,</span></span>
<span class="line"><span style="color:#B07D48">  tokenize</span><span style="color:#999999">,</span></span>
<span class="line"><span style="color:#999999">}</span><span style="color:#1E754F"> from</span><span style="color:#B5695977"> "</span><span style="color:#B56959">../ralph/ralph-utils</span><span style="color:#B5695977">"</span><span style="color:#999999">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959">type</span><span style="color:#2E8F82"> RalphSession</span><span style="color:#999999"> =</span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#B07D48">  enabled</span><span style="color:#999999">: </span><span style="color:#2E8F82">boolean</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#B07D48">  promptPath</span><span style="color:#999999">: </span><span style="color:#2E8F82">string</span><span style="color:#999999">;</span><span style="color:#A0ADA0"> // repo-relative</span></span>
<span class="line"><span style="color:#B07D48">  maxIterations</span><span style="color:#999999">: </span><span style="color:#2E8F82">number</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#B07D48">  iteration</span><span style="color:#999999">: </span><span style="color:#2E8F82">number</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#999999">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959">type</span><span style="color:#2E8F82"> RalphState</span><span style="color:#999999"> =</span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#B07D48">  version</span><span style="color:#999999">: </span><span style="color:#2F798A">1</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#B07D48">  sessions</span><span style="color:#999999">: </span><span style="color:#2E8F82">Record</span><span style="color:#999999">&#x3C;</span><span style="color:#2E8F82">string</span><span style="color:#999999">, </span><span style="color:#2E8F82">RalphSession</span><span style="color:#999999">>;</span></span>
<span class="line"><span style="color:#999999">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959">type</span><span style="color:#2E8F82"> ChatMessageInput</span><span style="color:#999999"> =</span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#B07D48">  sessionID</span><span style="color:#999999">: </span><span style="color:#2E8F82">string</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#999999">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959">type</span><span style="color:#2E8F82"> ChatMessageOutput</span><span style="color:#999999"> =</span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#B07D48">  parts</span><span style="color:#999999">: </span><span style="color:#2E8F82">unknown</span><span style="color:#999999">[];</span></span>
<span class="line"><span style="color:#999999">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959">type</span><span style="color:#2E8F82"> SessionMessage</span><span style="color:#999999"> =</span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#B07D48">  info</span><span style="color:#AB5959">?</span><span style="color:#999999">: {</span></span>
<span class="line"><span style="color:#B07D48">    role</span><span style="color:#AB5959">?</span><span style="color:#999999">: </span><span style="color:#2E8F82">string</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#999999">  };</span></span>
<span class="line"><span style="color:#B07D48">  parts</span><span style="color:#AB5959">?</span><span style="color:#999999">: </span><span style="color:#2E8F82">unknown</span><span style="color:#999999">[];</span></span>
<span class="line"><span style="color:#999999">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959">type</span><span style="color:#2E8F82"> SessionMessagesResponse</span><span style="color:#999999"> =</span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#B07D48">  data</span><span style="color:#AB5959">?</span><span style="color:#999999">: </span><span style="color:#2E8F82">SessionMessage</span><span style="color:#999999">[];</span></span>
<span class="line"><span style="color:#999999">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959">type</span><span style="color:#2E8F82"> IdleEvent</span><span style="color:#999999"> =</span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#B07D48">  type</span><span style="color:#999999">: </span><span style="color:#2E8F82">string</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#B07D48">  properties</span><span style="color:#999999">: {</span></span>
<span class="line"><span style="color:#B07D48">    sessionID</span><span style="color:#999999">: </span><span style="color:#2E8F82">string</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#999999">  };</span></span>
<span class="line"><span style="color:#999999">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959">type</span><span style="color:#2E8F82"> IdleEventInput</span><span style="color:#999999"> =</span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#B07D48">  event</span><span style="color:#999999">: </span><span style="color:#2E8F82">IdleEvent</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#999999">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959">type</span><span style="color:#2E8F82"> ToolExecuteInput</span><span style="color:#999999"> =</span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#B07D48">  sessionID</span><span style="color:#999999">: </span><span style="color:#2E8F82">string</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#B07D48">  tool</span><span style="color:#999999">: </span><span style="color:#2E8F82">string</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#999999">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959">type</span><span style="color:#2E8F82"> ToolExecuteOutput</span><span style="color:#999999"> =</span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#B07D48">  args</span><span style="color:#AB5959">?</span><span style="color:#999999">: {</span></span>
<span class="line"><span style="color:#B07D48">    command</span><span style="color:#AB5959">?</span><span style="color:#999999">: </span><span style="color:#2E8F82">string</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#B07D48">    filePath</span><span style="color:#AB5959">?</span><span style="color:#999999">: </span><span style="color:#2E8F82">string</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#999999">  };</span></span>
<span class="line"><span style="color:#999999">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F">export</span><span style="color:#AB5959"> const </span><span style="color:#59873A">RalphLoopPlugin</span><span style="color:#999999">: </span><span style="color:#2E8F82">Plugin</span><span style="color:#999999"> =</span><span style="color:#AB5959"> async </span><span style="color:#999999">({</span><span style="color:#B07D48"> client</span><span style="color:#999999">,</span><span style="color:#B07D48"> worktree</span><span style="color:#999999"> })</span><span style="color:#999999"> =></span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#AB5959">  const </span><span style="color:#B07D48">stateFile</span><span style="color:#999999"> =</span><span style="color:#B07D48"> path</span><span style="color:#999999">.</span><span style="color:#59873A">join</span><span style="color:#999999">(</span><span style="color:#B07D48">worktree</span><span style="color:#999999">,</span><span style="color:#B5695977"> "</span><span style="color:#B56959">.opencode</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#B5695977"> "</span><span style="color:#B56959">ralph</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#B5695977"> "</span><span style="color:#B56959">state.json</span><span style="color:#B5695977">"</span><span style="color:#999999">);</span></span>
<span class="line"><span style="color:#AB5959">  const </span><span style="color:#B07D48">state</span><span style="color:#999999"> =</span><span style="color:#1E754F"> await</span><span style="color:#59873A"> loadJson</span><span style="color:#999999">&#x3C;</span><span style="color:#2E8F82">RalphState</span><span style="color:#999999">>(</span><span style="color:#B07D48">stateFile</span><span style="color:#999999">,</span><span style="color:#999999"> { </span><span style="color:#998418">version</span><span style="color:#999999">: </span><span style="color:#2F798A">1</span><span style="color:#999999">, </span><span style="color:#998418">sessions</span><span style="color:#999999">: {} });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959">  const </span><span style="color:#59873A">toast</span><span style="color:#999999"> =</span><span style="color:#AB5959"> async </span><span style="color:#999999">(</span></span>
<span class="line"><span style="color:#B07D48">    message</span><span style="color:#999999">: </span><span style="color:#2E8F82">string</span><span style="color:#999999">,</span></span>
<span class="line"><span style="color:#B07D48">    variant</span><span style="color:#999999">: </span><span style="color:#B5695977">"</span><span style="color:#B56959">info</span><span style="color:#B5695977">"</span><span style="color:#999999"> | </span><span style="color:#B5695977">"</span><span style="color:#B56959">success</span><span style="color:#B5695977">"</span><span style="color:#999999"> | </span><span style="color:#B5695977">"</span><span style="color:#B56959">warning</span><span style="color:#B5695977">"</span><span style="color:#999999"> | </span><span style="color:#B5695977">"</span><span style="color:#B56959">error</span><span style="color:#B5695977">"</span><span style="color:#999999"> =</span><span style="color:#B5695977"> "</span><span style="color:#B56959">info</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span></span>
<span class="line"><span style="color:#999999">  ):</span><span style="color:#2E8F82"> Promise</span><span style="color:#999999">&#x3C;</span><span style="color:#2E8F82">void</span><span style="color:#999999">></span><span style="color:#999999"> =></span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#1E754F">    await</span><span style="color:#B07D48"> client</span><span style="color:#999999">.</span><span style="color:#B07D48">tui</span><span style="color:#999999">.</span><span style="color:#59873A">showToast</span><span style="color:#999999">({ </span><span style="color:#998418">body</span><span style="color:#999999">: { </span><span style="color:#998418">title</span><span style="color:#999999">: </span><span style="color:#B5695977">"</span><span style="color:#B56959">Ralph</span><span style="color:#B5695977">"</span><span style="color:#999999">, </span><span style="color:#B07D48">message</span><span style="color:#999999">, </span><span style="color:#B07D48">variant</span><span style="color:#999999"> } });</span></span>
<span class="line"><span style="color:#999999">  };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959">  const </span><span style="color:#59873A">persist</span><span style="color:#999999"> =</span><span style="color:#999999"> ()</span><span style="color:#999999"> =></span><span style="color:#59873A"> saveJson</span><span style="color:#999999">(</span><span style="color:#B07D48">stateFile</span><span style="color:#999999">,</span><span style="color:#B07D48"> state</span><span style="color:#999999">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959">  const </span><span style="color:#59873A">stop</span><span style="color:#999999"> =</span><span style="color:#AB5959"> async </span><span style="color:#999999">(</span><span style="color:#B07D48">sessionID</span><span style="color:#999999">: </span><span style="color:#2E8F82">string</span><span style="color:#999999">,</span><span style="color:#B07D48"> reason</span><span style="color:#999999">: </span><span style="color:#2E8F82">string</span><span style="color:#999999">)</span><span style="color:#999999"> =></span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#AB5959">    const </span><span style="color:#B07D48">s</span><span style="color:#999999"> =</span><span style="color:#B07D48"> state</span><span style="color:#999999">.</span><span style="color:#B07D48">sessions</span><span style="color:#999999">?.[</span><span style="color:#B07D48">sessionID</span><span style="color:#999999">];</span></span>
<span class="line"><span style="color:#1E754F">    if</span><span style="color:#999999"> (</span><span style="color:#AB5959">!</span><span style="color:#B07D48">s</span><span style="color:#999999">?.</span><span style="color:#B07D48">enabled</span><span style="color:#999999">)</span><span style="color:#1E754F"> return</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#B07D48">    s</span><span style="color:#999999">.</span><span style="color:#B07D48">enabled</span><span style="color:#999999"> =</span><span style="color:#1E754F"> false</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#1E754F">    await</span><span style="color:#59873A"> persist</span><span style="color:#999999">();</span></span>
<span class="line"><span style="color:#1E754F">    await</span><span style="color:#59873A"> toast</span><span style="color:#999999">(</span><span style="color:#B5695977">`</span><span style="color:#B56959">Stopped: </span><span style="color:#1E754F">${</span><span style="color:#B56959">reason</span><span style="color:#1E754F">}</span><span style="color:#B5695977">`</span><span style="color:#999999">,</span><span style="color:#B5695977"> "</span><span style="color:#B56959">warning</span><span style="color:#B5695977">"</span><span style="color:#999999">);</span></span>
<span class="line"><span style="color:#999999">  };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959">  const </span><span style="color:#59873A">start</span><span style="color:#999999"> =</span><span style="color:#AB5959"> async </span><span style="color:#999999">(</span><span style="color:#B07D48">sessionID</span><span style="color:#999999">: </span><span style="color:#2E8F82">string</span><span style="color:#999999">,</span><span style="color:#B07D48"> promptArg</span><span style="color:#999999">: </span><span style="color:#2E8F82">string</span><span style="color:#999999">,</span><span style="color:#B07D48"> maxArg</span><span style="color:#AB5959">?</span><span style="color:#999999">: </span><span style="color:#2E8F82">string</span><span style="color:#999999">)</span><span style="color:#999999"> =></span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#AB5959">    const </span><span style="color:#B07D48">raw</span><span style="color:#999999"> =</span><span style="color:#59873A"> stripArg</span><span style="color:#999999">(</span><span style="color:#B07D48">promptArg</span><span style="color:#999999">);</span></span>
<span class="line"><span style="color:#AB5959">    const </span><span style="color:#B07D48">abs</span><span style="color:#999999"> =</span><span style="color:#B07D48"> path</span><span style="color:#999999">.</span><span style="color:#59873A">isAbsolute</span><span style="color:#999999">(</span><span style="color:#B07D48">raw</span><span style="color:#999999">)</span><span style="color:#AB5959"> ? </span><span style="color:#B07D48">raw</span><span style="color:#AB5959"> : </span><span style="color:#B07D48">path</span><span style="color:#999999">.</span><span style="color:#59873A">resolve</span><span style="color:#999999">(</span><span style="color:#B07D48">worktree</span><span style="color:#999999">,</span><span style="color:#B07D48"> raw</span><span style="color:#999999">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959">    let </span><span style="color:#B07D48">real</span><span style="color:#999999"> =</span><span style="color:#B07D48"> abs</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#1E754F">    try</span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#B07D48">      real</span><span style="color:#999999"> =</span><span style="color:#1E754F"> await</span><span style="color:#B07D48"> fs</span><span style="color:#999999">.</span><span style="color:#59873A">realpath</span><span style="color:#999999">(</span><span style="color:#B07D48">abs</span><span style="color:#999999">);</span></span>
<span class="line"><span style="color:#999999">    }</span><span style="color:#1E754F"> catch</span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#A0ADA0">      // ignore</span></span>
<span class="line"><span style="color:#999999">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F">    if</span><span style="color:#999999"> (</span><span style="color:#AB5959">!</span><span style="color:#59873A">isPathInside</span><span style="color:#999999">(</span><span style="color:#B07D48">worktree</span><span style="color:#999999">,</span><span style="color:#B07D48"> real</span><span style="color:#999999">))</span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#1E754F">      await</span><span style="color:#59873A"> toast</span><span style="color:#999999">(</span><span style="color:#B5695977">`</span><span style="color:#B56959">Refusing to start: prompt file is outside repo (</span><span style="color:#1E754F">${</span><span style="color:#B56959">promptArg</span><span style="color:#1E754F">}</span><span style="color:#B56959">)</span><span style="color:#B5695977">`</span><span style="color:#999999">,</span><span style="color:#B5695977"> "</span><span style="color:#B56959">error</span><span style="color:#B5695977">"</span><span style="color:#999999">);</span></span>
<span class="line"><span style="color:#1E754F">      return</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#999999">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F">    try</span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#1E754F">      if</span><span style="color:#999999"> (</span><span style="color:#AB5959">!</span><span style="color:#999999">(</span><span style="color:#1E754F">await</span><span style="color:#B07D48"> fs</span><span style="color:#999999">.</span><span style="color:#59873A">stat</span><span style="color:#999999">(</span><span style="color:#B07D48">real</span><span style="color:#999999">)).</span><span style="color:#59873A">isFile</span><span style="color:#999999">())</span><span style="color:#1E754F"> throw</span><span style="color:#AB5959"> new </span><span style="color:#59873A">Error</span><span style="color:#999999">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">not file</span><span style="color:#B5695977">"</span><span style="color:#999999">);</span></span>
<span class="line"><span style="color:#999999">    }</span><span style="color:#1E754F"> catch</span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#1E754F">      await</span><span style="color:#59873A"> toast</span><span style="color:#999999">(</span><span style="color:#B5695977">`</span><span style="color:#B56959">Refusing to start: prompt file not found (</span><span style="color:#1E754F">${</span><span style="color:#B56959">promptArg</span><span style="color:#1E754F">}</span><span style="color:#B56959">)</span><span style="color:#B5695977">`</span><span style="color:#999999">,</span><span style="color:#B5695977"> "</span><span style="color:#B56959">error</span><span style="color:#B5695977">"</span><span style="color:#999999">);</span></span>
<span class="line"><span style="color:#1E754F">      return</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#999999">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959">    const </span><span style="color:#B07D48">md</span><span style="color:#999999"> =</span><span style="color:#1E754F"> await</span><span style="color:#B07D48"> fs</span><span style="color:#999999">.</span><span style="color:#59873A">readFile</span><span style="color:#999999">(</span><span style="color:#B07D48">real</span><span style="color:#999999">,</span><span style="color:#B5695977"> "</span><span style="color:#B56959">utf8</span><span style="color:#B5695977">"</span><span style="color:#999999">);</span></span>
<span class="line"><span style="color:#AB5959">    const </span><span style="color:#B07D48">lintErrors</span><span style="color:#999999"> =</span><span style="color:#59873A"> lintPrompt</span><span style="color:#999999">(</span><span style="color:#B07D48">md</span><span style="color:#999999">);</span></span>
<span class="line"><span style="color:#1E754F">    if</span><span style="color:#999999"> (</span><span style="color:#B07D48">lintErrors</span><span style="color:#999999">.</span><span style="color:#998418">length</span><span style="color:#999999">)</span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#1E754F">      await</span><span style="color:#59873A"> toast</span><span style="color:#999999">(</span><span style="color:#B5695977">`</span><span style="color:#B56959">Prompt file lint failed:</span><span style="color:#A65E2B">\n</span><span style="color:#B56959">- </span><span style="color:#1E754F">${</span><span style="color:#B56959">lintErrors</span><span style="color:#999999">.</span><span style="color:#59873A">join</span><span style="color:#999999">(</span><span style="color:#B5695977">"</span><span style="color:#A65E2B">\n</span><span style="color:#B56959">- </span><span style="color:#B5695977">"</span><span style="color:#999999">)</span><span style="color:#1E754F">}</span><span style="color:#B5695977">`</span><span style="color:#999999">,</span><span style="color:#B5695977"> "</span><span style="color:#B56959">error</span><span style="color:#B5695977">"</span><span style="color:#999999">);</span></span>
<span class="line"><span style="color:#1E754F">      return</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#999999">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959">    const </span><span style="color:#B07D48">maxIterations</span><span style="color:#999999"> =</span></span>
<span class="line"><span style="color:#B07D48">      maxArg</span><span style="color:#AB5959"> &#x26;&#x26;</span><span style="color:#B5695977"> /</span><span style="color:#1E754F">^</span><span style="color:#999999">[</span><span style="color:#A65E2B">0-9</span><span style="color:#999999">]</span><span style="color:#2F798A">+</span><span style="color:#1E754F">$</span><span style="color:#B5695977">/</span><span style="color:#999999">.</span><span style="color:#59873A">test</span><span style="color:#999999">(</span><span style="color:#59873A">String</span><span style="color:#999999">(</span><span style="color:#B07D48">maxArg</span><span style="color:#999999">))</span><span style="color:#AB5959"> ? </span><span style="color:#59873A">Number</span><span style="color:#999999">(</span><span style="color:#B07D48">maxArg</span><span style="color:#999999">)</span><span style="color:#AB5959"> : </span><span style="color:#B07D48">DEFAULT_MAX_ITERATIONS</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#B07D48">    state</span><span style="color:#999999">.</span><span style="color:#B07D48">sessions</span><span style="color:#999999">[</span><span style="color:#B07D48">sessionID</span><span style="color:#999999">]</span><span style="color:#999999"> = {</span></span>
<span class="line"><span style="color:#998418">      enabled</span><span style="color:#999999">: </span><span style="color:#1E754F">true</span><span style="color:#999999">,</span></span>
<span class="line"><span style="color:#998418">      promptPath</span><span style="color:#999999">: </span><span style="color:#B07D48">path</span><span style="color:#999999">.</span><span style="color:#59873A">relative</span><span style="color:#999999">(</span><span style="color:#B07D48">worktree</span><span style="color:#999999">, </span><span style="color:#B07D48">real</span><span style="color:#999999">),</span></span>
<span class="line"><span style="color:#B07D48">      maxIterations</span><span style="color:#999999">,</span></span>
<span class="line"><span style="color:#998418">      iteration</span><span style="color:#999999">: </span><span style="color:#2F798A">0</span><span style="color:#999999">,</span></span>
<span class="line"><span style="color:#999999">    };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F">    await</span><span style="color:#59873A"> persist</span><span style="color:#999999">();</span></span>
<span class="line"><span style="color:#1E754F">    await</span><span style="color:#59873A"> toast</span><span style="color:#999999">(</span></span>
<span class="line"><span style="color:#B5695977">      `</span><span style="color:#B56959">Enabled (max </span><span style="color:#1E754F">${</span><span style="color:#B56959">maxIterations</span><span style="color:#1E754F">}</span><span style="color:#B56959">) using </span><span style="color:#1E754F">${</span><span style="color:#B56959">state</span><span style="color:#999999">.</span><span style="color:#B56959">sessions</span><span style="color:#999999">[</span><span style="color:#B56959">sessionID</span><span style="color:#999999">].</span><span style="color:#B56959">promptPath</span><span style="color:#1E754F">}</span><span style="color:#B5695977">`</span><span style="color:#999999">,</span></span>
<span class="line"><span style="color:#B5695977">      "</span><span style="color:#B56959">success</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span></span>
<span class="line"><span style="color:#999999">    );</span></span>
<span class="line"><span style="color:#999999">  };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959">  const </span><span style="color:#59873A">guardBash</span><span style="color:#999999"> =</span><span style="color:#999999"> (</span><span style="color:#B07D48">command</span><span style="color:#999999">: </span><span style="color:#2E8F82">string</span><span style="color:#999999">,</span><span style="color:#B07D48"> session</span><span style="color:#999999">: </span><span style="color:#2E8F82">RalphSession</span><span style="color:#999999">)</span><span style="color:#999999"> =></span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#AB5959">    const </span><span style="color:#B07D48">cmd</span><span style="color:#999999"> =</span><span style="color:#59873A"> String</span><span style="color:#999999">(</span><span style="color:#B07D48">command</span><span style="color:#AB5959"> ?? </span><span style="color:#B5695977">""</span><span style="color:#999999">).</span><span style="color:#59873A">trim</span><span style="color:#999999">();</span></span>
<span class="line"><span style="color:#1E754F">    if</span><span style="color:#999999"> (</span><span style="color:#AB5959">!</span><span style="color:#B07D48">cmd</span><span style="color:#999999">)</span><span style="color:#1E754F"> return</span><span style="color:#999999">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959">    const </span><span style="color:#B07D48">worktreeAbs</span><span style="color:#999999"> =</span><span style="color:#B07D48"> path</span><span style="color:#999999">.</span><span style="color:#59873A">resolve</span><span style="color:#999999">(</span><span style="color:#B07D48">worktree</span><span style="color:#999999">);</span></span>
<span class="line"><span style="color:#AB5959">    const </span><span style="color:#B07D48">promptAbs</span><span style="color:#999999"> =</span><span style="color:#B07D48"> path</span><span style="color:#999999">.</span><span style="color:#59873A">resolve</span><span style="color:#999999">(</span><span style="color:#B07D48">worktreeAbs</span><span style="color:#999999">,</span><span style="color:#B07D48"> session</span><span style="color:#999999">.</span><span style="color:#B07D48">promptPath</span><span style="color:#999999">);</span></span>
<span class="line"><span style="color:#AB5959">    const </span><span style="color:#B07D48">promptRel</span><span style="color:#999999"> =</span><span style="color:#59873A"> normalizeRelToken</span><span style="color:#999999">(</span><span style="color:#B07D48">session</span><span style="color:#999999">.</span><span style="color:#B07D48">promptPath</span><span style="color:#999999">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959">    let </span><span style="color:#B07D48">simulatedCwd</span><span style="color:#999999"> =</span><span style="color:#B07D48"> worktreeAbs</span><span style="color:#999999">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959">    const </span><span style="color:#59873A">assertInside</span><span style="color:#999999"> =</span><span style="color:#999999"> (</span><span style="color:#B07D48">absPath</span><span style="color:#999999">: </span><span style="color:#2E8F82">string</span><span style="color:#999999">,</span><span style="color:#B07D48"> operation</span><span style="color:#999999">: </span><span style="color:#2E8F82">string</span><span style="color:#999999">)</span><span style="color:#999999"> =></span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#1E754F">      if</span><span style="color:#999999"> (</span><span style="color:#AB5959">!</span><span style="color:#59873A">isPathInside</span><span style="color:#999999">(</span><span style="color:#B07D48">worktreeAbs</span><span style="color:#999999">,</span><span style="color:#B07D48"> absPath</span><span style="color:#999999">))</span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#1E754F">        throw</span><span style="color:#AB5959"> new </span><span style="color:#59873A">Error</span><span style="color:#999999">(</span><span style="color:#B5695977">`</span><span style="color:#B56959">Ralph safety: refusing to </span><span style="color:#1E754F">${</span><span style="color:#B56959">operation</span><span style="color:#1E754F">}</span><span style="color:#B56959"> outside repo</span><span style="color:#B5695977">`</span><span style="color:#999999">);</span></span>
<span class="line"><span style="color:#999999">      }</span></span>
<span class="line"><span style="color:#999999">    };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959">    const </span><span style="color:#59873A">resolveFromCwd</span><span style="color:#999999"> =</span><span style="color:#999999"> (</span><span style="color:#B07D48">maybePath</span><span style="color:#999999">: </span><span style="color:#2E8F82">string</span><span style="color:#999999">)</span><span style="color:#999999"> =></span></span>
<span class="line"><span style="color:#B07D48">      path</span><span style="color:#999999">.</span><span style="color:#59873A">isAbsolute</span><span style="color:#999999">(</span><span style="color:#B07D48">maybePath</span><span style="color:#999999">)</span><span style="color:#AB5959"> ? </span><span style="color:#B07D48">path</span><span style="color:#999999">.</span><span style="color:#59873A">resolve</span><span style="color:#999999">(</span><span style="color:#B07D48">maybePath</span><span style="color:#999999">)</span><span style="color:#AB5959"> : </span><span style="color:#B07D48">path</span><span style="color:#999999">.</span><span style="color:#59873A">resolve</span><span style="color:#999999">(</span><span style="color:#B07D48">simulatedCwd</span><span style="color:#999999">,</span><span style="color:#B07D48"> maybePath</span><span style="color:#999999">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F">    for</span><span style="color:#999999"> (</span><span style="color:#AB5959">const </span><span style="color:#B07D48">seg</span><span style="color:#AB5959"> of </span><span style="color:#59873A">splitShellSegments</span><span style="color:#999999">(</span><span style="color:#B07D48">cmd</span><span style="color:#999999">))</span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#AB5959">      const </span><span style="color:#B07D48">tokens</span><span style="color:#999999"> =</span><span style="color:#59873A"> stripEnvPrefixes</span><span style="color:#999999">(</span><span style="color:#59873A">tokenize</span><span style="color:#999999">(</span><span style="color:#B07D48">seg</span><span style="color:#999999">));</span></span>
<span class="line"><span style="color:#AB5959">      const </span><span style="color:#B07D48">a</span><span style="color:#999999"> =</span><span style="color:#B07D48"> tokens</span><span style="color:#999999">[</span><span style="color:#2F798A">0</span><span style="color:#999999">]</span><span style="color:#AB5959"> ?? </span><span style="color:#B5695977">""</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#AB5959">      const </span><span style="color:#B07D48">b</span><span style="color:#999999"> =</span><span style="color:#B07D48"> tokens</span><span style="color:#999999">[</span><span style="color:#2F798A">1</span><span style="color:#999999">]</span><span style="color:#AB5959"> ?? </span><span style="color:#B5695977">""</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#1E754F">      if</span><span style="color:#999999"> (</span><span style="color:#AB5959">!</span><span style="color:#B07D48">a</span><span style="color:#999999">)</span><span style="color:#1E754F"> continue</span><span style="color:#999999">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0">      // Track `cd` so relative destructive ops resolve correctly.</span></span>
<span class="line"><span style="color:#1E754F">      if</span><span style="color:#999999"> (</span><span style="color:#B07D48">a</span><span style="color:#AB5959"> === </span><span style="color:#B5695977">"</span><span style="color:#B56959">cd</span><span style="color:#B5695977">"</span><span style="color:#999999">)</span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#AB5959">        const </span><span style="color:#B07D48">dest</span><span style="color:#999999"> =</span><span style="color:#B07D48"> tokens</span><span style="color:#999999">[</span><span style="color:#2F798A">1</span><span style="color:#999999">];</span></span>
<span class="line"><span style="color:#1E754F">        if</span><span style="color:#999999"> (</span><span style="color:#AB5959">!</span><span style="color:#B07D48">dest</span><span style="color:#AB5959"> || </span><span style="color:#B07D48">dest</span><span style="color:#AB5959"> === </span><span style="color:#B5695977">"</span><span style="color:#B56959">-</span><span style="color:#B5695977">"</span><span style="color:#999999">)</span><span style="color:#1E754F"> throw</span><span style="color:#AB5959"> new </span><span style="color:#59873A">Error</span><span style="color:#999999">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">Ralph safety: refusing ambiguous cd</span><span style="color:#B5695977">"</span><span style="color:#999999">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F">        if</span><span style="color:#999999"> (</span><span style="color:#B5695977">/</span><span style="color:#999999">[</span><span style="color:#A65E2B">`$</span><span style="color:#999999">]</span><span style="color:#B5695977">/</span><span style="color:#999999">.</span><span style="color:#59873A">test</span><span style="color:#999999">(</span><span style="color:#59873A">String</span><span style="color:#999999">(</span><span style="color:#B07D48">dest</span><span style="color:#999999">)))</span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#1E754F">          throw</span><span style="color:#AB5959"> new </span><span style="color:#59873A">Error</span><span style="color:#999999">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">Ralph safety: refusing non-literal cd target</span><span style="color:#B5695977">"</span><span style="color:#999999">);</span></span>
<span class="line"><span style="color:#999999">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959">        const </span><span style="color:#B07D48">normalized</span><span style="color:#999999"> =</span><span style="color:#59873A"> normalizeRelToken</span><span style="color:#999999">(</span><span style="color:#59873A">String</span><span style="color:#999999">(</span><span style="color:#B07D48">dest</span><span style="color:#999999">));</span></span>
<span class="line"><span style="color:#1E754F">        if</span><span style="color:#999999"> (</span></span>
<span class="line"><span style="color:#B07D48">          normalized</span><span style="color:#999999">.</span><span style="color:#59873A">startsWith</span><span style="color:#999999">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">~</span><span style="color:#B5695977">"</span><span style="color:#999999">)</span><span style="color:#AB5959"> ||</span></span>
<span class="line"><span style="color:#B07D48">          normalized</span><span style="color:#999999">.</span><span style="color:#59873A">startsWith</span><span style="color:#999999">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">$HOME</span><span style="color:#B5695977">"</span><span style="color:#999999">)</span><span style="color:#AB5959"> ||</span></span>
<span class="line"><span style="color:#B07D48">          normalized</span><span style="color:#999999">.</span><span style="color:#59873A">startsWith</span><span style="color:#999999">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">${HOME}</span><span style="color:#B5695977">"</span><span style="color:#999999">)</span></span>
<span class="line"><span style="color:#999999">        )</span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#1E754F">          throw</span><span style="color:#AB5959"> new </span><span style="color:#59873A">Error</span><span style="color:#999999">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">Ralph safety: refusing cd to home paths</span><span style="color:#B5695977">"</span><span style="color:#999999">);</span></span>
<span class="line"><span style="color:#999999">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959">        const </span><span style="color:#B07D48">next</span><span style="color:#999999"> =</span><span style="color:#59873A"> resolveFromCwd</span><span style="color:#999999">(</span><span style="color:#59873A">String</span><span style="color:#999999">(</span><span style="color:#B07D48">dest</span><span style="color:#999999">));</span></span>
<span class="line"><span style="color:#59873A">        assertInside</span><span style="color:#999999">(</span><span style="color:#B07D48">next</span><span style="color:#999999">,</span><span style="color:#B5695977"> "</span><span style="color:#B56959">cd</span><span style="color:#B5695977">"</span><span style="color:#999999">);</span></span>
<span class="line"><span style="color:#B07D48">        simulatedCwd</span><span style="color:#999999"> =</span><span style="color:#B07D48"> next</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#1E754F">        continue</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#999999">      }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F">      if</span><span style="color:#999999"> (</span><span style="color:#B07D48">a</span><span style="color:#AB5959"> === </span><span style="color:#B5695977">"</span><span style="color:#B56959">sudo</span><span style="color:#B5695977">"</span><span style="color:#999999">)</span><span style="color:#1E754F"> throw</span><span style="color:#AB5959"> new </span><span style="color:#59873A">Error</span><span style="color:#999999">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">Ralph safety: sudo is disabled</span><span style="color:#B5695977">"</span><span style="color:#999999">);</span></span>
<span class="line"><span style="color:#1E754F">      if</span><span style="color:#999999"> (</span><span style="color:#B07D48">a</span><span style="color:#AB5959"> === </span><span style="color:#B5695977">"</span><span style="color:#B56959">git</span><span style="color:#B5695977">"</span><span style="color:#AB5959"> &#x26;&#x26; </span><span style="color:#B07D48">b</span><span style="color:#AB5959"> === </span><span style="color:#B5695977">"</span><span style="color:#B56959">push</span><span style="color:#B5695977">"</span><span style="color:#999999">)</span><span style="color:#1E754F"> throw</span><span style="color:#AB5959"> new </span><span style="color:#59873A">Error</span><span style="color:#999999">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">Ralph safety: git push is disabled</span><span style="color:#B5695977">"</span><span style="color:#999999">);</span></span>
<span class="line"><span style="color:#1E754F">      if</span><span style="color:#999999"> (</span><span style="color:#B07D48">a</span><span style="color:#AB5959"> === </span><span style="color:#B5695977">"</span><span style="color:#B56959">git</span><span style="color:#B5695977">"</span><span style="color:#AB5959"> &#x26;&#x26; </span><span style="color:#B07D48">b</span><span style="color:#AB5959"> === </span><span style="color:#B5695977">"</span><span style="color:#B56959">clean</span><span style="color:#B5695977">"</span><span style="color:#AB5959"> &#x26;&#x26; </span><span style="color:#B07D48">tokens</span><span style="color:#999999">.</span><span style="color:#59873A">some</span><span style="color:#999999">((</span><span style="color:#B07D48">t</span><span style="color:#999999">)</span><span style="color:#999999"> =></span><span style="color:#59873A"> String</span><span style="color:#999999">(</span><span style="color:#B07D48">t</span><span style="color:#999999">).</span><span style="color:#59873A">includes</span><span style="color:#999999">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">-f</span><span style="color:#B5695977">"</span><span style="color:#999999">)))</span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#1E754F">        throw</span><span style="color:#AB5959"> new </span><span style="color:#59873A">Error</span><span style="color:#999999">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">Ralph safety: git clean with -f is disabled</span><span style="color:#B5695977">"</span><span style="color:#999999">);</span></span>
<span class="line"><span style="color:#999999">      }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959">      const </span><span style="color:#B07D48">isRm</span><span style="color:#999999"> =</span><span style="color:#B07D48"> a</span><span style="color:#AB5959"> === </span><span style="color:#B5695977">"</span><span style="color:#B56959">rm</span><span style="color:#B5695977">"</span><span style="color:#AB5959"> || </span><span style="color:#B07D48">a</span><span style="color:#AB5959"> === </span><span style="color:#B5695977">"</span><span style="color:#B56959">rmdir</span><span style="color:#B5695977">"</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#AB5959">      const </span><span style="color:#B07D48">isGitRm</span><span style="color:#999999"> =</span><span style="color:#B07D48"> a</span><span style="color:#AB5959"> === </span><span style="color:#B5695977">"</span><span style="color:#B56959">git</span><span style="color:#B5695977">"</span><span style="color:#AB5959"> &#x26;&#x26; </span><span style="color:#B07D48">b</span><span style="color:#AB5959"> === </span><span style="color:#B5695977">"</span><span style="color:#B56959">rm</span><span style="color:#B5695977">"</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#AB5959">      const </span><span style="color:#B07D48">isMv</span><span style="color:#999999"> =</span><span style="color:#B07D48"> a</span><span style="color:#AB5959"> === </span><span style="color:#B5695977">"</span><span style="color:#B56959">mv</span><span style="color:#B5695977">"</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#AB5959">      const </span><span style="color:#B07D48">isGitMv</span><span style="color:#999999"> =</span><span style="color:#B07D48"> a</span><span style="color:#AB5959"> === </span><span style="color:#B5695977">"</span><span style="color:#B56959">git</span><span style="color:#B5695977">"</span><span style="color:#AB5959"> &#x26;&#x26; </span><span style="color:#B07D48">b</span><span style="color:#AB5959"> === </span><span style="color:#B5695977">"</span><span style="color:#B56959">mv</span><span style="color:#B5695977">"</span><span style="color:#999999">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0">      // Prevent prompt file moves/renames (and prevent moving files outside repo).</span></span>
<span class="line"><span style="color:#1E754F">      if</span><span style="color:#999999"> (</span><span style="color:#B07D48">isMv</span><span style="color:#AB5959"> || </span><span style="color:#B07D48">isGitMv</span><span style="color:#999999">)</span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#AB5959">        const </span><span style="color:#B07D48">offset</span><span style="color:#999999"> =</span><span style="color:#B07D48"> isGitMv</span><span style="color:#AB5959"> ? </span><span style="color:#2F798A">2</span><span style="color:#AB5959"> : </span><span style="color:#2F798A">1</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#AB5959">        const </span><span style="color:#B07D48">paths</span><span style="color:#999999"> =</span><span style="color:#59873A"> rmTargetsFromArgs</span><span style="color:#999999">(</span><span style="color:#B07D48">tokens</span><span style="color:#999999">.</span><span style="color:#59873A">slice</span><span style="color:#999999">(</span><span style="color:#B07D48">offset</span><span style="color:#999999">));</span></span>
<span class="line"><span style="color:#1E754F">        for</span><span style="color:#999999"> (</span><span style="color:#AB5959">const </span><span style="color:#B07D48">rawTok</span><span style="color:#AB5959"> of </span><span style="color:#B07D48">paths</span><span style="color:#999999">)</span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#AB5959">          const </span><span style="color:#B07D48">raw</span><span style="color:#999999"> =</span><span style="color:#59873A"> String</span><span style="color:#999999">(</span><span style="color:#B07D48">rawTok</span><span style="color:#999999">);</span></span>
<span class="line"><span style="color:#1E754F">          if</span><span style="color:#999999"> (</span><span style="color:#B5695977">/</span><span style="color:#999999">[</span><span style="color:#A65E2B">`$</span><span style="color:#999999">]</span><span style="color:#B5695977">/</span><span style="color:#999999">.</span><span style="color:#59873A">test</span><span style="color:#999999">(</span><span style="color:#B07D48">raw</span><span style="color:#999999">))</span><span style="color:#1E754F"> throw</span><span style="color:#AB5959"> new </span><span style="color:#59873A">Error</span><span style="color:#999999">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">Ralph safety: refusing non-literal mv path</span><span style="color:#B5695977">"</span><span style="color:#999999">);</span></span>
<span class="line"><span style="color:#AB5959">          const </span><span style="color:#B07D48">abs</span><span style="color:#999999"> =</span><span style="color:#59873A"> resolveFromCwd</span><span style="color:#999999">(</span><span style="color:#B07D48">raw</span><span style="color:#999999">);</span></span>
<span class="line"><span style="color:#1E754F">          if</span><span style="color:#999999"> (</span><span style="color:#B07D48">abs</span><span style="color:#AB5959"> === </span><span style="color:#B07D48">promptAbs</span><span style="color:#999999">)</span></span>
<span class="line"><span style="color:#1E754F">            throw</span><span style="color:#AB5959"> new </span><span style="color:#59873A">Error</span><span style="color:#999999">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">Ralph safety: cannot move/rename the prompt file</span><span style="color:#B5695977">"</span><span style="color:#999999">);</span></span>
<span class="line"><span style="color:#59873A">          assertInside</span><span style="color:#999999">(</span><span style="color:#B07D48">abs</span><span style="color:#999999">,</span><span style="color:#B5695977"> "</span><span style="color:#B56959">move files</span><span style="color:#B5695977">"</span><span style="color:#999999">);</span></span>
<span class="line"><span style="color:#999999">        }</span></span>
<span class="line"><span style="color:#1E754F">        continue</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#999999">      }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F">      if</span><span style="color:#999999"> (</span><span style="color:#AB5959">!</span><span style="color:#B07D48">isRm</span><span style="color:#AB5959"> &#x26;&#x26; !</span><span style="color:#B07D48">isGitRm</span><span style="color:#999999">)</span><span style="color:#1E754F"> continue</span><span style="color:#999999">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959">      const </span><span style="color:#B07D48">offset</span><span style="color:#999999"> =</span><span style="color:#B07D48"> isGitRm</span><span style="color:#AB5959"> ? </span><span style="color:#2F798A">2</span><span style="color:#AB5959"> : </span><span style="color:#2F798A">1</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#AB5959">      const </span><span style="color:#B07D48">targets</span><span style="color:#999999"> =</span><span style="color:#59873A"> rmTargetsFromArgs</span><span style="color:#999999">(</span><span style="color:#B07D48">tokens</span><span style="color:#999999">.</span><span style="color:#59873A">slice</span><span style="color:#999999">(</span><span style="color:#B07D48">offset</span><span style="color:#999999">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F">      for</span><span style="color:#999999"> (</span><span style="color:#AB5959">const </span><span style="color:#B07D48">rawTok</span><span style="color:#AB5959"> of </span><span style="color:#B07D48">targets</span><span style="color:#999999">)</span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#AB5959">        const </span><span style="color:#B07D48">raw</span><span style="color:#999999"> =</span><span style="color:#59873A"> String</span><span style="color:#999999">(</span><span style="color:#B07D48">rawTok</span><span style="color:#999999">);</span></span>
<span class="line"><span style="color:#1E754F">        if</span><span style="color:#999999"> (</span><span style="color:#B5695977">/</span><span style="color:#999999">[</span><span style="color:#A65E2B">`$</span><span style="color:#999999">]</span><span style="color:#B5695977">/</span><span style="color:#999999">.</span><span style="color:#59873A">test</span><span style="color:#999999">(</span><span style="color:#B07D48">raw</span><span style="color:#999999">))</span><span style="color:#1E754F"> throw</span><span style="color:#AB5959"> new </span><span style="color:#59873A">Error</span><span style="color:#999999">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">Ralph safety: refusing non-literal rm target</span><span style="color:#B5695977">"</span><span style="color:#999999">);</span></span>
<span class="line"><span style="color:#AB5959">        const </span><span style="color:#B07D48">normalizedForWipe</span><span style="color:#999999"> =</span><span style="color:#59873A"> normalizeRelToken</span><span style="color:#999999">(</span><span style="color:#B07D48">raw</span><span style="color:#999999">).</span><span style="color:#59873A">replace</span><span style="color:#999999">(</span><span style="color:#B5695977">/</span><span style="color:#BDA437">\/</span><span style="color:#2F798A">+</span><span style="color:#1E754F">$</span><span style="color:#B5695977">/</span><span style="color:#999999">,</span><span style="color:#B5695977"> ""</span><span style="color:#999999">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0">        // Block the classic "oops" wipes.</span></span>
<span class="line"><span style="color:#1E754F">        if</span><span style="color:#999999"> (</span><span style="color:#B07D48">normalizedForWipe</span><span style="color:#AB5959"> === </span><span style="color:#B5695977">""</span><span style="color:#AB5959"> || </span><span style="color:#B07D48">normalizedForWipe</span><span style="color:#AB5959"> === </span><span style="color:#B5695977">"</span><span style="color:#B56959">.</span><span style="color:#B5695977">"</span><span style="color:#AB5959"> || </span><span style="color:#B07D48">normalizedForWipe</span><span style="color:#AB5959"> === </span><span style="color:#B5695977">"</span><span style="color:#B56959">*</span><span style="color:#B5695977">"</span><span style="color:#999999">)</span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#1E754F">          throw</span><span style="color:#AB5959"> new </span><span style="color:#59873A">Error</span><span style="color:#999999">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">Ralph safety: refusing repo wipe</span><span style="color:#B5695977">"</span><span style="color:#999999">);</span></span>
<span class="line"><span style="color:#999999">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F">        if</span><span style="color:#999999"> (</span><span style="color:#B07D48">raw</span><span style="color:#AB5959"> === </span><span style="color:#B5695977">"</span><span style="color:#B56959">/</span><span style="color:#B5695977">"</span><span style="color:#AB5959"> || </span><span style="color:#B07D48">raw</span><span style="color:#AB5959"> === </span><span style="color:#B5695977">"</span><span style="color:#B56959">/*</span><span style="color:#B5695977">"</span><span style="color:#999999">)</span><span style="color:#1E754F"> throw</span><span style="color:#AB5959"> new </span><span style="color:#59873A">Error</span><span style="color:#999999">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">Ralph safety: refusing disk wipe</span><span style="color:#B5695977">"</span><span style="color:#999999">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F">        if</span><span style="color:#999999"> (</span></span>
<span class="line"><span style="color:#B07D48">          normalizedForWipe</span><span style="color:#999999">.</span><span style="color:#59873A">startsWith</span><span style="color:#999999">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">~</span><span style="color:#B5695977">"</span><span style="color:#999999">)</span><span style="color:#AB5959"> ||</span></span>
<span class="line"><span style="color:#B07D48">          normalizedForWipe</span><span style="color:#999999">.</span><span style="color:#59873A">startsWith</span><span style="color:#999999">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">$HOME</span><span style="color:#B5695977">"</span><span style="color:#999999">)</span><span style="color:#AB5959"> ||</span></span>
<span class="line"><span style="color:#B07D48">          normalizedForWipe</span><span style="color:#999999">.</span><span style="color:#59873A">startsWith</span><span style="color:#999999">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">${HOME}</span><span style="color:#B5695977">"</span><span style="color:#999999">)</span></span>
<span class="line"><span style="color:#999999">        )</span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#1E754F">          throw</span><span style="color:#AB5959"> new </span><span style="color:#59873A">Error</span><span style="color:#999999">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">Ralph safety: refusing home paths</span><span style="color:#B5695977">"</span><span style="color:#999999">);</span></span>
<span class="line"><span style="color:#999999">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0">        // Protect the prompt file.</span></span>
<span class="line"><span style="color:#1E754F">        if</span><span style="color:#999999"> (</span><span style="color:#B07D48">normalizedForWipe</span><span style="color:#AB5959"> === </span><span style="color:#B07D48">promptRel</span><span style="color:#999999">)</span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#1E754F">          throw</span><span style="color:#AB5959"> new </span><span style="color:#59873A">Error</span><span style="color:#999999">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">Ralph safety: cannot delete the prompt file</span><span style="color:#B5695977">"</span><span style="color:#999999">);</span></span>
<span class="line"><span style="color:#999999">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959">        const </span><span style="color:#B07D48">abs</span><span style="color:#999999"> =</span><span style="color:#59873A"> resolveFromCwd</span><span style="color:#999999">(</span><span style="color:#B07D48">raw</span><span style="color:#999999">);</span></span>
<span class="line"><span style="color:#1E754F">        if</span><span style="color:#999999"> (</span><span style="color:#B07D48">abs</span><span style="color:#AB5959"> === </span><span style="color:#B07D48">promptAbs</span><span style="color:#999999">)</span><span style="color:#1E754F"> throw</span><span style="color:#AB5959"> new </span><span style="color:#59873A">Error</span><span style="color:#999999">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">Ralph safety: cannot delete the prompt file</span><span style="color:#B5695977">"</span><span style="color:#999999">);</span></span>
<span class="line"><span style="color:#1E754F">        if</span><span style="color:#999999"> (</span><span style="color:#B07D48">abs</span><span style="color:#AB5959"> === </span><span style="color:#B07D48">worktreeAbs</span><span style="color:#999999">)</span><span style="color:#1E754F"> throw</span><span style="color:#AB5959"> new </span><span style="color:#59873A">Error</span><span style="color:#999999">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">Ralph safety: refusing to delete repo root</span><span style="color:#B5695977">"</span><span style="color:#999999">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#59873A">        assertInside</span><span style="color:#999999">(</span><span style="color:#B07D48">abs</span><span style="color:#999999">,</span><span style="color:#B5695977"> "</span><span style="color:#B56959">delete files</span><span style="color:#B5695977">"</span><span style="color:#999999">);</span></span>
<span class="line"><span style="color:#999999">      }</span></span>
<span class="line"><span style="color:#999999">    }</span></span>
<span class="line"><span style="color:#999999">  };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959">  const </span><span style="color:#59873A">runIteration</span><span style="color:#999999"> =</span><span style="color:#AB5959"> async </span><span style="color:#999999">(</span><span style="color:#B07D48">sessionID</span><span style="color:#999999">: </span><span style="color:#2E8F82">string</span><span style="color:#999999">,</span><span style="color:#B07D48"> session</span><span style="color:#999999">: </span><span style="color:#2E8F82">RalphSession</span><span style="color:#999999">)</span><span style="color:#999999"> =></span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#1E754F">    if</span><span style="color:#999999"> (</span><span style="color:#B07D48">session</span><span style="color:#999999">.</span><span style="color:#B07D48">iteration</span><span style="color:#999999"> >=</span><span style="color:#B07D48"> session</span><span style="color:#999999">.</span><span style="color:#B07D48">maxIterations</span><span style="color:#999999">)</span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#1E754F">      await</span><span style="color:#59873A"> stop</span><span style="color:#999999">(</span><span style="color:#B07D48">sessionID</span><span style="color:#999999">,</span><span style="color:#B5695977"> `</span><span style="color:#B56959">max iterations reached (</span><span style="color:#1E754F">${</span><span style="color:#B56959">session</span><span style="color:#999999">.</span><span style="color:#B56959">maxIterations</span><span style="color:#1E754F">}</span><span style="color:#B56959">)</span><span style="color:#B5695977">`</span><span style="color:#999999">);</span></span>
<span class="line"><span style="color:#1E754F">      return</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#999999">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959">    const </span><span style="color:#B07D48">promptReal</span><span style="color:#999999"> =</span><span style="color:#B07D48"> path</span><span style="color:#999999">.</span><span style="color:#59873A">join</span><span style="color:#999999">(</span><span style="color:#B07D48">worktree</span><span style="color:#999999">,</span><span style="color:#B07D48"> session</span><span style="color:#999999">.</span><span style="color:#B07D48">promptPath</span><span style="color:#999999">);</span></span>
<span class="line"><span style="color:#AB5959">    const </span><span style="color:#B07D48">promptContents</span><span style="color:#999999"> =</span><span style="color:#1E754F"> await</span><span style="color:#B07D48"> fs</span><span style="color:#999999">.</span><span style="color:#59873A">readFile</span><span style="color:#999999">(</span><span style="color:#B07D48">promptReal</span><span style="color:#999999">,</span><span style="color:#B5695977"> "</span><span style="color:#B56959">utf8</span><span style="color:#B5695977">"</span><span style="color:#999999">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B07D48">    session</span><span style="color:#999999">.</span><span style="color:#B07D48">iteration</span><span style="color:#AB5959"> += </span><span style="color:#2F798A">1</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#1E754F">    await</span><span style="color:#59873A"> persist</span><span style="color:#999999">();</span></span>
<span class="line"><span style="color:#1E754F">    await</span><span style="color:#59873A"> toast</span><span style="color:#999999">(</span><span style="color:#B5695977">`</span><span style="color:#B56959">Iteration </span><span style="color:#1E754F">${</span><span style="color:#B56959">session</span><span style="color:#999999">.</span><span style="color:#B56959">iteration</span><span style="color:#1E754F">}</span><span style="color:#B56959">/</span><span style="color:#1E754F">${</span><span style="color:#B56959">session</span><span style="color:#999999">.</span><span style="color:#B56959">maxIterations</span><span style="color:#1E754F">}</span><span style="color:#B5695977">`</span><span style="color:#999999">,</span><span style="color:#B5695977"> "</span><span style="color:#B56959">info</span><span style="color:#B5695977">"</span><span style="color:#999999">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959">    const </span><span style="color:#B07D48">msg</span><span style="color:#999999"> =</span><span style="color:#999999"> [</span></span>
<span class="line"><span style="color:#B5695977">      `</span><span style="color:#B56959">&#x3C;ralph_iteration number="</span><span style="color:#1E754F">${</span><span style="color:#B56959">session</span><span style="color:#999999">.</span><span style="color:#B56959">iteration</span><span style="color:#1E754F">}</span><span style="color:#B56959">" max="</span><span style="color:#1E754F">${</span><span style="color:#B56959">session</span><span style="color:#999999">.</span><span style="color:#B56959">maxIterations</span><span style="color:#1E754F">}</span><span style="color:#B56959">"></span><span style="color:#B5695977">`</span><span style="color:#999999">,</span></span>
<span class="line"><span style="color:#B5695977">      "</span><span style="color:#B56959">&#x3C;ralph_rules></span><span style="color:#B5695977">"</span><span style="color:#999999">,</span></span>
<span class="line"><span style="color:#B5695977">      "</span><span style="color:#B56959">- Task spec: follow the content in &#x3C;task_prompt_file>.</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span></span>
<span class="line"><span style="color:#B5695977">      "</span><span style="color:#B56959">- Read `## Progress` as you may have already started coding and done some work.</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span></span>
<span class="line"><span style="color:#B5695977">      "</span><span style="color:#B56959">- Focus: pick the single most useful next step you can complete now.</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span></span>
<span class="line"><span style="color:#B5695977">      "</span><span style="color:#B56959">- Make concrete progress in implementing the features/functionality described in that doc. Do this by coding in this repo/working directory.</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span></span>
<span class="line"><span style="color:#B5695977">      "</span><span style="color:#B56959">- Once you are done, update the prompt file, especially `## Progress`, to be accurate with your progress so far.</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span></span>
<span class="line"><span style="color:#B5695977">      "</span><span style="color:#B56959">- In `## Progress`, record: what you changed, current status, next step, and any verification results/errors.</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span></span>
<span class="line"><span style="color:#B5695977">      "</span><span style="color:#B56959">- Keep the prompt file concise and current; it is durable memory (chat may be compacted).</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span></span>
<span class="line"><span style="color:#B5695977">      "</span><span style="color:#B56959">- Use ## Acceptance Criteria to define done; use ## Verification to prove it.</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span></span>
<span class="line"><span style="color:#B5695977">      "</span><span style="color:#B56959">- If a command is blocked/denied, do not retry it; choose a safer alternative and note it in ## Progress.</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span></span>
<span class="line"><span style="color:#B5695977">      "</span><span style="color:#B56959">- If stuck, log the blocker and what you tried in ## Progress, then attempt the next best approach.</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span></span>
<span class="line"><span style="color:#B5695977">      `</span><span style="color:#B56959">- Completion: only when fully complete and verified, end your final message with a line containing only: </span><span style="color:#1E754F">${</span><span style="color:#B56959">DONE_TOKEN</span><span style="color:#1E754F">}</span><span style="color:#B5695977">`</span><span style="color:#999999">,</span></span>
<span class="line"><span style="color:#B5695977">      "</span><span style="color:#B56959">&#x3C;/ralph_rules></span><span style="color:#B5695977">"</span><span style="color:#999999">,</span></span>
<span class="line"><span style="color:#B5695977">      `</span><span style="color:#B56959">&#x3C;task_prompt_file path="</span><span style="color:#1E754F">${</span><span style="color:#B56959">session</span><span style="color:#999999">.</span><span style="color:#B56959">promptPath</span><span style="color:#1E754F">}</span><span style="color:#B56959">"></span><span style="color:#B5695977">`</span><span style="color:#999999">,</span></span>
<span class="line"><span style="color:#B07D48">      promptContents</span><span style="color:#999999">,</span></span>
<span class="line"><span style="color:#B5695977">      "</span><span style="color:#B56959">&#x3C;/task_prompt_file></span><span style="color:#B5695977">"</span><span style="color:#999999">,</span></span>
<span class="line"><span style="color:#B5695977">      "</span><span style="color:#B56959">&#x3C;/ralph_iteration></span><span style="color:#B5695977">"</span><span style="color:#999999">,</span></span>
<span class="line"><span style="color:#999999">    ].</span><span style="color:#59873A">join</span><span style="color:#999999">(</span><span style="color:#B5695977">"</span><span style="color:#A65E2B">\n</span><span style="color:#B5695977">"</span><span style="color:#999999">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F">    await</span><span style="color:#B07D48"> client</span><span style="color:#999999">.</span><span style="color:#B07D48">session</span><span style="color:#999999">.</span><span style="color:#59873A">prompt</span><span style="color:#999999">({</span></span>
<span class="line"><span style="color:#998418">      path</span><span style="color:#999999">: { </span><span style="color:#998418">id</span><span style="color:#999999">: </span><span style="color:#B07D48">sessionID</span><span style="color:#999999"> },</span></span>
<span class="line"><span style="color:#998418">      body</span><span style="color:#999999">: { </span><span style="color:#998418">agent</span><span style="color:#999999">: </span><span style="color:#B5695977">"</span><span style="color:#B56959">ralph</span><span style="color:#B5695977">"</span><span style="color:#999999">, </span><span style="color:#998418">parts</span><span style="color:#999999">: [{ </span><span style="color:#998418">type</span><span style="color:#999999">: </span><span style="color:#B5695977">"</span><span style="color:#B56959">text</span><span style="color:#B5695977">"</span><span style="color:#999999">, </span><span style="color:#998418">text</span><span style="color:#999999">: </span><span style="color:#B07D48">msg</span><span style="color:#999999"> }] },</span></span>
<span class="line"><span style="color:#999999">    });</span></span>
<span class="line"><span style="color:#999999">  };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F">  return</span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#B5695977">    "</span><span style="color:#B56959">chat.message</span><span style="color:#B5695977">"</span><span style="color:#999999">: </span><span style="color:#AB5959">async</span><span style="color:#999999"> (</span><span style="color:#B07D48">input</span><span style="color:#999999">: </span><span style="color:#2E8F82">ChatMessageInput</span><span style="color:#999999">, </span><span style="color:#B07D48">output</span><span style="color:#999999">: </span><span style="color:#2E8F82">ChatMessageOutput</span><span style="color:#999999">) => {</span></span>
<span class="line"><span style="color:#AB5959">      const </span><span style="color:#B07D48">text</span><span style="color:#999999"> =</span><span style="color:#59873A"> textFromParts</span><span style="color:#999999">(</span><span style="color:#B07D48">output</span><span style="color:#999999">.</span><span style="color:#B07D48">parts</span><span style="color:#999999">);</span></span>
<span class="line"><span style="color:#1E754F">      if</span><span style="color:#999999"> (</span><span style="color:#AB5959">!</span><span style="color:#B07D48">text</span><span style="color:#999999">.</span><span style="color:#59873A">includes</span><span style="color:#999999">(</span><span style="color:#B07D48">CONTROL_PREFIX</span><span style="color:#999999">)) </span><span style="color:#1E754F">return</span><span style="color:#999999">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959">      const </span><span style="color:#B07D48">control</span><span style="color:#999999"> =</span><span style="color:#59873A"> parseControl</span><span style="color:#999999">(</span><span style="color:#B07D48">text</span><span style="color:#999999">);</span></span>
<span class="line"><span style="color:#1E754F">      if</span><span style="color:#999999"> (</span><span style="color:#AB5959">!</span><span style="color:#B07D48">control</span><span style="color:#999999">) </span><span style="color:#1E754F">return</span><span style="color:#59873A"> toast</span><span style="color:#999999">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">Could not parse RALPH_CONTROL JSON</span><span style="color:#B5695977">"</span><span style="color:#999999">, </span><span style="color:#B5695977">"</span><span style="color:#B56959">error</span><span style="color:#B5695977">"</span><span style="color:#999999">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959">      const </span><span style="color:#B07D48">arg1</span><span style="color:#999999"> =</span><span style="color:#59873A"> String</span><span style="color:#999999">(</span><span style="color:#B07D48">control</span><span style="color:#999999">.</span><span style="color:#B07D48">arg1</span><span style="color:#AB5959"> ?? </span><span style="color:#B5695977">""</span><span style="color:#999999">).</span><span style="color:#59873A">trim</span><span style="color:#999999">();</span></span>
<span class="line"><span style="color:#AB5959">      const </span><span style="color:#B07D48">arg2</span><span style="color:#999999"> =</span><span style="color:#59873A"> String</span><span style="color:#999999">(</span><span style="color:#B07D48">control</span><span style="color:#999999">.</span><span style="color:#B07D48">arg2</span><span style="color:#AB5959"> ?? </span><span style="color:#B5695977">""</span><span style="color:#999999">).</span><span style="color:#59873A">trim</span><span style="color:#999999">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F">      if</span><span style="color:#999999"> (</span><span style="color:#AB5959">!</span><span style="color:#B07D48">arg1</span><span style="color:#999999">) </span><span style="color:#1E754F">return</span><span style="color:#59873A"> toast</span><span style="color:#999999">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">Usage: /ralph @prompt.md [max]  OR  /ralph stop</span><span style="color:#B5695977">"</span><span style="color:#999999">, </span><span style="color:#B5695977">"</span><span style="color:#B56959">error</span><span style="color:#B5695977">"</span><span style="color:#999999">);</span></span>
<span class="line"><span style="color:#1E754F">      if</span><span style="color:#999999"> (</span><span style="color:#B07D48">arg1</span><span style="color:#AB5959"> ===</span><span style="color:#B5695977"> "</span><span style="color:#B56959">stop</span><span style="color:#B5695977">"</span><span style="color:#999999">) </span><span style="color:#1E754F">return</span><span style="color:#59873A"> stop</span><span style="color:#999999">(</span><span style="color:#B07D48">input</span><span style="color:#999999">.</span><span style="color:#B07D48">sessionID</span><span style="color:#999999">, </span><span style="color:#B5695977">"</span><span style="color:#B56959">manual stop</span><span style="color:#B5695977">"</span><span style="color:#999999">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F">      return</span><span style="color:#59873A"> start</span><span style="color:#999999">(</span><span style="color:#B07D48">input</span><span style="color:#999999">.</span><span style="color:#B07D48">sessionID</span><span style="color:#999999">, </span><span style="color:#B07D48">arg1</span><span style="color:#999999">, </span><span style="color:#B07D48">arg2</span><span style="color:#999999">);</span></span>
<span class="line"><span style="color:#999999">    },</span></span>
<span class="line"></span>
<span class="line"><span style="color:#59873A">    event</span><span style="color:#999999">: </span><span style="color:#AB5959">async</span><span style="color:#999999"> ({ </span><span style="color:#B07D48">event</span><span style="color:#999999"> }: </span><span style="color:#2E8F82">IdleEventInput</span><span style="color:#999999">) => {</span></span>
<span class="line"><span style="color:#1E754F">      if</span><span style="color:#999999"> (</span><span style="color:#B07D48">event</span><span style="color:#999999">.</span><span style="color:#B07D48">type</span><span style="color:#AB5959"> !==</span><span style="color:#B5695977"> "</span><span style="color:#B56959">session.idle</span><span style="color:#B5695977">"</span><span style="color:#999999">) </span><span style="color:#1E754F">return</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#AB5959">      const </span><span style="color:#B07D48">sessionID</span><span style="color:#999999"> =</span><span style="color:#B07D48"> event</span><span style="color:#999999">.</span><span style="color:#B07D48">properties</span><span style="color:#999999">.</span><span style="color:#B07D48">sessionID</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#AB5959">      const </span><span style="color:#B07D48">session</span><span style="color:#999999"> =</span><span style="color:#B07D48"> state</span><span style="color:#999999">.</span><span style="color:#B07D48">sessions</span><span style="color:#999999">?.[</span><span style="color:#B07D48">sessionID</span><span style="color:#999999">];</span></span>
<span class="line"><span style="color:#1E754F">      if</span><span style="color:#999999"> (</span><span style="color:#AB5959">!</span><span style="color:#B07D48">session</span><span style="color:#999999">?.</span><span style="color:#B07D48">enabled</span><span style="color:#999999">) </span><span style="color:#1E754F">return</span><span style="color:#999999">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F">      try</span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#AB5959">        const </span><span style="color:#B07D48">messagesResult</span><span style="color:#999999"> =</span><span style="color:#999999"> (</span><span style="color:#1E754F">await</span><span style="color:#B07D48"> client</span><span style="color:#999999">.</span><span style="color:#B07D48">session</span><span style="color:#999999">.</span><span style="color:#59873A">messages</span><span style="color:#999999">({</span></span>
<span class="line"><span style="color:#998418">          path</span><span style="color:#999999">: { </span><span style="color:#998418">id</span><span style="color:#999999">: </span><span style="color:#B07D48">sessionID</span><span style="color:#999999"> },</span></span>
<span class="line"><span style="color:#998418">          query</span><span style="color:#999999">: { </span><span style="color:#998418">limit</span><span style="color:#999999">: </span><span style="color:#2F798A">25</span><span style="color:#999999"> },</span></span>
<span class="line"><span style="color:#999999">        }))</span><span style="color:#1E754F"> as</span><span style="color:#2E8F82"> SessionMessagesResponse</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#AB5959">        const </span><span style="color:#B07D48">messages</span><span style="color:#999999"> =</span><span style="color:#B07D48"> messagesResult</span><span style="color:#999999">.</span><span style="color:#B07D48">data</span><span style="color:#AB5959"> ?? </span><span style="color:#999999">[];</span></span>
<span class="line"><span style="color:#AB5959">        const </span><span style="color:#B07D48">lastAssistant</span><span style="color:#999999"> =</span><span style="color:#999999"> [...</span><span style="color:#B07D48">messages</span><span style="color:#999999">].</span><span style="color:#59873A">reverse</span><span style="color:#999999">().</span><span style="color:#59873A">find</span><span style="color:#999999">((</span><span style="color:#B07D48">m</span><span style="color:#999999">)</span><span style="color:#999999"> =></span><span style="color:#B07D48"> m</span><span style="color:#999999">.</span><span style="color:#B07D48">info</span><span style="color:#999999">?.</span><span style="color:#B07D48">role</span><span style="color:#AB5959"> === </span><span style="color:#B5695977">"</span><span style="color:#B56959">assistant</span><span style="color:#B5695977">"</span><span style="color:#999999">);</span></span>
<span class="line"><span style="color:#1E754F">        if</span><span style="color:#999999"> (</span><span style="color:#B07D48">lastAssistant</span><span style="color:#AB5959"> &#x26;&#x26;</span><span style="color:#59873A"> hasDone</span><span style="color:#999999">(</span><span style="color:#59873A">textFromParts</span><span style="color:#999999">(</span><span style="color:#B07D48">lastAssistant</span><span style="color:#999999">.</span><span style="color:#B07D48">parts</span><span style="color:#AB5959"> ??</span><span style="color:#999999"> [])))</span></span>
<span class="line"><span style="color:#1E754F">          return</span><span style="color:#59873A"> stop</span><span style="color:#999999">(</span><span style="color:#B07D48">sessionID</span><span style="color:#999999">, </span><span style="color:#B07D48">DONE_TOKEN</span><span style="color:#999999">);</span></span>
<span class="line"><span style="color:#999999">      } </span><span style="color:#1E754F">catch</span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#A0ADA0">        // ignore</span></span>
<span class="line"><span style="color:#999999">      }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F">      return</span><span style="color:#59873A"> runIteration</span><span style="color:#999999">(</span><span style="color:#B07D48">sessionID</span><span style="color:#999999">, </span><span style="color:#B07D48">session</span><span style="color:#999999">);</span></span>
<span class="line"><span style="color:#999999">    },</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B5695977">    "</span><span style="color:#B56959">tool.execute.before</span><span style="color:#B5695977">"</span><span style="color:#999999">: </span><span style="color:#AB5959">async</span><span style="color:#999999"> (</span><span style="color:#B07D48">input</span><span style="color:#999999">: </span><span style="color:#2E8F82">ToolExecuteInput</span><span style="color:#999999">, </span><span style="color:#B07D48">output</span><span style="color:#999999">: </span><span style="color:#2E8F82">ToolExecuteOutput</span><span style="color:#999999">) => {</span></span>
<span class="line"><span style="color:#AB5959">      const </span><span style="color:#B07D48">session</span><span style="color:#999999"> =</span><span style="color:#B07D48"> state</span><span style="color:#999999">.</span><span style="color:#B07D48">sessions</span><span style="color:#999999">?.[</span><span style="color:#B07D48">input</span><span style="color:#999999">.</span><span style="color:#B07D48">sessionID</span><span style="color:#999999">];</span></span>
<span class="line"><span style="color:#1E754F">      if</span><span style="color:#999999"> (</span><span style="color:#AB5959">!</span><span style="color:#B07D48">session</span><span style="color:#999999">?.</span><span style="color:#B07D48">enabled</span><span style="color:#999999">) </span><span style="color:#1E754F">return</span><span style="color:#999999">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F">      if</span><span style="color:#999999"> (</span><span style="color:#B07D48">input</span><span style="color:#999999">.</span><span style="color:#B07D48">tool</span><span style="color:#AB5959"> ===</span><span style="color:#B5695977"> "</span><span style="color:#B56959">bash</span><span style="color:#B5695977">"</span><span style="color:#999999">) {</span></span>
<span class="line"><span style="color:#59873A">        guardBash</span><span style="color:#999999">(</span><span style="color:#B07D48">output</span><span style="color:#999999">.</span><span style="color:#B07D48">args</span><span style="color:#999999">?.</span><span style="color:#B07D48">command</span><span style="color:#999999">, </span><span style="color:#B07D48">session</span><span style="color:#999999">);</span></span>
<span class="line"><span style="color:#1E754F">        return</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#999999">      }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F">      if</span><span style="color:#999999"> (</span><span style="color:#B07D48">input</span><span style="color:#999999">.</span><span style="color:#B07D48">tool</span><span style="color:#AB5959"> ===</span><span style="color:#B5695977"> "</span><span style="color:#B56959">read</span><span style="color:#B5695977">"</span><span style="color:#AB5959"> ||</span><span style="color:#B07D48"> input</span><span style="color:#999999">.</span><span style="color:#B07D48">tool</span><span style="color:#AB5959"> ===</span><span style="color:#B5695977"> "</span><span style="color:#B56959">write</span><span style="color:#B5695977">"</span><span style="color:#AB5959"> ||</span><span style="color:#B07D48"> input</span><span style="color:#999999">.</span><span style="color:#B07D48">tool</span><span style="color:#AB5959"> ===</span><span style="color:#B5695977"> "</span><span style="color:#B56959">edit</span><span style="color:#B5695977">"</span><span style="color:#999999">) {</span></span>
<span class="line"><span style="color:#AB5959">        const </span><span style="color:#B07D48">filePath</span><span style="color:#999999"> =</span><span style="color:#B07D48"> output</span><span style="color:#999999">.</span><span style="color:#B07D48">args</span><span style="color:#999999">?.</span><span style="color:#B07D48">filePath</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#1E754F">        if</span><span style="color:#999999"> (</span><span style="color:#AB5959">typeof</span><span style="color:#B07D48"> filePath</span><span style="color:#AB5959"> !==</span><span style="color:#B5695977"> "</span><span style="color:#B56959">string</span><span style="color:#B5695977">"</span><span style="color:#AB5959"> ||</span><span style="color:#AB5959"> !</span><span style="color:#B07D48">filePath</span><span style="color:#999999">) </span><span style="color:#1E754F">return</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#AB5959">        const </span><span style="color:#B07D48">abs</span><span style="color:#999999"> =</span><span style="color:#B07D48"> path</span><span style="color:#999999">.</span><span style="color:#59873A">isAbsolute</span><span style="color:#999999">(</span><span style="color:#B07D48">filePath</span><span style="color:#999999">)</span><span style="color:#AB5959"> ? </span><span style="color:#B07D48">filePath</span><span style="color:#AB5959"> : </span><span style="color:#B07D48">path</span><span style="color:#999999">.</span><span style="color:#59873A">resolve</span><span style="color:#999999">(</span><span style="color:#B07D48">worktree</span><span style="color:#999999">,</span><span style="color:#B07D48"> filePath</span><span style="color:#999999">);</span></span>
<span class="line"><span style="color:#1E754F">        if</span><span style="color:#999999"> (</span><span style="color:#AB5959">!</span><span style="color:#59873A">isPathInside</span><span style="color:#999999">(</span><span style="color:#B07D48">worktree</span><span style="color:#999999">, </span><span style="color:#B07D48">abs</span><span style="color:#999999">))</span></span>
<span class="line"><span style="color:#1E754F">          throw</span><span style="color:#AB5959"> new</span><span style="color:#59873A"> Error</span><span style="color:#999999">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">Ralph safety: file access outside repo is disabled</span><span style="color:#B5695977">"</span><span style="color:#999999">);</span></span>
<span class="line"><span style="color:#999999">      }</span></span>
<span class="line"><span style="color:#999999">    },</span></span>
<span class="line"><span style="color:#999999">  };</span></span>
<span class="line"><span style="color:#999999">};</span></span>
<span class="line"></span></code></pre>19:T13ad,/// <reference path="../types/shims.d.ts" />

import fs from "node:fs/promises";
import path from "node:path";

export const CONTROL_PREFIX = "RALPH_CONTROL:";
export const DONE_TOKEN = "RALPH_DONE";
export const DEFAULT_MAX_ITERATIONS = 25;

export const REQUIRED_SECTIONS = [
  "Goal",
  "Acceptance Criteria",
  "Verification",
  "Progress",
] as const;
export const REQUIRED_NONEMPTY = ["Goal", "Acceptance Criteria", "Verification"] as const;

export const isPathInside = (root: string, target: string) => {
  const rel = path.relative(root, target);
  return rel === "" || (!rel.startsWith(`..${path.sep}`) && rel !== "..");
};

export const stripArg = (value: unknown) => {
  const s = String(value ?? "").trim();
  const unquoted =
    (s.startsWith('"') && s.endsWith('"')) || (s.startsWith("'") && s.endsWith("'"))
      ? s.slice(1, -1)
      : s;
  return unquoted.startsWith("@") ? unquoted.slice(1) : unquoted;
};

const escapeRe = (s: string) => s.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");

const sectionBody = (md: string, title: string) => {
  const re = new RegExp(
    `^#{1,6}\\s+${escapeRe(title)}\\s*$\\r?\\n([\\s\\S]*?)(?=^#{1,6}\\s+|\\Z)`,
    "im",
  );
  const m = re.exec(md);
  return m ? m[1].trim() : null;
};

export const lintPrompt = (md: string) => {
  const errors: string[] = [];

  for (const s of REQUIRED_SECTIONS) {
    if (sectionBody(md, s) === null) errors.push(`Missing section heading: ${s}`);
  }

  for (const s of REQUIRED_NONEMPTY) {
    const body = sectionBody(md, s);
    if (body !== null && !body) errors.push(`Section must not be empty: ${s}`);
  }

  return errors;
};

export const loadJson = async <T>(filePath: string, fallback: T): Promise<T> => {
  try {
    return JSON.parse(await fs.readFile(filePath, "utf8")) as T;
  } catch {
    return fallback;
  }
};

export const saveJson = async (filePath: string, value: unknown) => {
  await fs.mkdir(path.dirname(filePath), { recursive: true });
  await fs.writeFile(filePath, `${JSON.stringify(value, null, 2)}\n`, "utf8");
};

type TextPartLike = { type: "text"; text: string };

export const textFromParts = (parts: unknown[]) =>
  (Array.isArray(parts) ? parts : [])
    .filter((p): p is TextPartLike => {
      if (typeof p !== "object" || p === null) return false;
      const candidate = p as { type?: unknown; text?: unknown };
      return candidate.type === "text" && typeof candidate.text === "string";
    })
    .map((p) => p.text)
    .join("\n");

export const hasDone = (text: string) =>
  String(text)
    .split(/\r?\n/)
    .some((l) => l.trim() === DONE_TOKEN);

export const parseControl = (text: string) => {
  const line = String(text)
    .split(/\r?\n/)
    .map((l) => l.trim())
    .find((l) => l.startsWith(CONTROL_PREFIX));

  if (!line) return null;

  try {
    return JSON.parse(line.slice(CONTROL_PREFIX.length).trim()) as {
      arg1?: unknown;
      arg2?: unknown;
      arg3?: unknown;
    };
  } catch {
    return null;
  }
};

export const tokenize = (cmd: string) => {
  const out: string[] = [];
  let cur = "";
  let q: '"' | "'" | null = null;

  for (let i = 0; i < cmd.length; i++) {
    const c = cmd[i];

    if (q) {
      if (c === q) q = null;
      else cur += c;
      continue;
    }

    if (c === '"' || c === "'") {
      q = c;
      continue;
    }

    if (/\s/.test(c)) {
      if (cur) out.push(cur);
      cur = "";
      continue;
    }

    cur += c;
  }

  if (cur) out.push(cur);
  return out;
};

export const normalizeRelToken = (t: string) =>
  String(t).replace(/\\/g, "/").replace(/^\.\//, "").trim();

export const splitShellSegments = (command: string) => {
  const segments: string[] = [];
  let cur = "";
  let q: '"' | "'" | null = null;

  const flush = () => {
    const trimmed = cur.trim();
    if (trimmed) segments.push(trimmed);
    cur = "";
  };

  for (let i = 0; i < command.length; i++) {
    const c = command[i];

    if (q) {
      if (c === q) q = null;
      cur += c;
      continue;
    }

    if (c === '"' || c === "'") {
      q = c;
      cur += c;
      continue;
    }

    // Split on unquoted ;, &&, ||, and newlines.
    if (c === ";" || c === "\n") {
      flush();
      continue;
    }

    if (c === "&" && command[i + 1] === "&") {
      flush();
      i++;
      continue;
    }

    if (c === "|" && command[i + 1] === "|") {
      flush();
      i++;
      continue;
    }

    cur += c;
  }

  flush();
  return segments;
};

const envAssignmentRe = /^[A-Za-z_][A-Za-z0-9_]*=.*/;

export const stripEnvPrefixes = (tokens: string[]) => {
  let i = 0;
  if (tokens[i] === "env") i++;
  while (i < tokens.length && envAssignmentRe.test(tokens[i] ?? "")) i++;
  return tokens.slice(i);
};

export const rmTargetsFromArgs = (args: string[]) => {
  const targets: string[] = [];
  let passthrough = false;

  for (const a of args) {
    if (!passthrough && a === "--") {
      passthrough = true;
      continue;
    }

    if (!passthrough && a.startsWith("-")) continue;
    targets.push(a);
  }

  return targets;
};
1a:Te43f,<pre class="shiki vitesse-light" style="background-color:#ffffff;color:#393a34" tabindex="0"><code><span class="line"><span style="color:#A0ADA0">/// </span><span style="color:#999999">&#x3C;</span><span style="color:#1E754F">reference</span><span style="color:#B07D48"> path</span><span style="color:#999999">=</span><span style="color:#B5695977">"</span><span style="color:#B56959">../types/shims.d.ts</span><span style="color:#B5695977">"</span><span style="color:#999999"> /></span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F">import</span><span style="color:#B07D48"> fs</span><span style="color:#1E754F"> from</span><span style="color:#B5695977"> "</span><span style="color:#B56959">node:fs/promises</span><span style="color:#B5695977">"</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#1E754F">import</span><span style="color:#B07D48"> path</span><span style="color:#1E754F"> from</span><span style="color:#B5695977"> "</span><span style="color:#B56959">node:path</span><span style="color:#B5695977">"</span><span style="color:#999999">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F">export</span><span style="color:#AB5959"> const </span><span style="color:#B07D48">CONTROL_PREFIX</span><span style="color:#999999"> =</span><span style="color:#B5695977"> "</span><span style="color:#B56959">RALPH_CONTROL:</span><span style="color:#B5695977">"</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#1E754F">export</span><span style="color:#AB5959"> const </span><span style="color:#B07D48">DONE_TOKEN</span><span style="color:#999999"> =</span><span style="color:#B5695977"> "</span><span style="color:#B56959">RALPH_DONE</span><span style="color:#B5695977">"</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#1E754F">export</span><span style="color:#AB5959"> const </span><span style="color:#B07D48">DEFAULT_MAX_ITERATIONS</span><span style="color:#999999"> =</span><span style="color:#2F798A"> 25</span><span style="color:#999999">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F">export</span><span style="color:#AB5959"> const </span><span style="color:#B07D48">REQUIRED_SECTIONS</span><span style="color:#999999"> =</span><span style="color:#999999"> [</span></span>
<span class="line"><span style="color:#B5695977">  "</span><span style="color:#B56959">Goal</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span></span>
<span class="line"><span style="color:#B5695977">  "</span><span style="color:#B56959">Acceptance Criteria</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span></span>
<span class="line"><span style="color:#B5695977">  "</span><span style="color:#B56959">Verification</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span></span>
<span class="line"><span style="color:#B5695977">  "</span><span style="color:#B56959">Progress</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span></span>
<span class="line"><span style="color:#999999">]</span><span style="color:#1E754F"> as</span><span style="color:#AB5959"> const</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#1E754F">export</span><span style="color:#AB5959"> const </span><span style="color:#B07D48">REQUIRED_NONEMPTY</span><span style="color:#999999"> =</span><span style="color:#999999"> [</span><span style="color:#B5695977">"</span><span style="color:#B56959">Goal</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#B5695977"> "</span><span style="color:#B56959">Acceptance Criteria</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span><span style="color:#B5695977"> "</span><span style="color:#B56959">Verification</span><span style="color:#B5695977">"</span><span style="color:#999999">]</span><span style="color:#1E754F"> as</span><span style="color:#AB5959"> const</span><span style="color:#999999">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F">export</span><span style="color:#AB5959"> const </span><span style="color:#59873A">isPathInside</span><span style="color:#999999"> =</span><span style="color:#999999"> (</span><span style="color:#B07D48">root</span><span style="color:#999999">: </span><span style="color:#2E8F82">string</span><span style="color:#999999">,</span><span style="color:#B07D48"> target</span><span style="color:#999999">: </span><span style="color:#2E8F82">string</span><span style="color:#999999">)</span><span style="color:#999999"> =></span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#AB5959">  const </span><span style="color:#B07D48">rel</span><span style="color:#999999"> =</span><span style="color:#B07D48"> path</span><span style="color:#999999">.</span><span style="color:#59873A">relative</span><span style="color:#999999">(</span><span style="color:#B07D48">root</span><span style="color:#999999">,</span><span style="color:#B07D48"> target</span><span style="color:#999999">);</span></span>
<span class="line"><span style="color:#1E754F">  return</span><span style="color:#B07D48"> rel</span><span style="color:#AB5959"> === </span><span style="color:#B5695977">""</span><span style="color:#AB5959"> || </span><span style="color:#999999">(</span><span style="color:#AB5959">!</span><span style="color:#B07D48">rel</span><span style="color:#999999">.</span><span style="color:#59873A">startsWith</span><span style="color:#999999">(</span><span style="color:#B5695977">`</span><span style="color:#B56959">..</span><span style="color:#1E754F">${</span><span style="color:#B56959">path</span><span style="color:#999999">.</span><span style="color:#B56959">sep</span><span style="color:#1E754F">}</span><span style="color:#B5695977">`</span><span style="color:#999999">)</span><span style="color:#AB5959"> &#x26;&#x26; </span><span style="color:#B07D48">rel</span><span style="color:#AB5959"> !== </span><span style="color:#B5695977">"</span><span style="color:#B56959">..</span><span style="color:#B5695977">"</span><span style="color:#999999">);</span></span>
<span class="line"><span style="color:#999999">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F">export</span><span style="color:#AB5959"> const </span><span style="color:#59873A">stripArg</span><span style="color:#999999"> =</span><span style="color:#999999"> (</span><span style="color:#B07D48">value</span><span style="color:#999999">: </span><span style="color:#2E8F82">unknown</span><span style="color:#999999">)</span><span style="color:#999999"> =></span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#AB5959">  const </span><span style="color:#B07D48">s</span><span style="color:#999999"> =</span><span style="color:#59873A"> String</span><span style="color:#999999">(</span><span style="color:#B07D48">value</span><span style="color:#AB5959"> ?? </span><span style="color:#B5695977">""</span><span style="color:#999999">).</span><span style="color:#59873A">trim</span><span style="color:#999999">();</span></span>
<span class="line"><span style="color:#AB5959">  const </span><span style="color:#B07D48">unquoted</span><span style="color:#999999"> =</span></span>
<span class="line"><span style="color:#999999">    (</span><span style="color:#B07D48">s</span><span style="color:#999999">.</span><span style="color:#59873A">startsWith</span><span style="color:#999999">(</span><span style="color:#B5695977">'</span><span style="color:#B56959">"</span><span style="color:#B5695977">'</span><span style="color:#999999">)</span><span style="color:#AB5959"> &#x26;&#x26; </span><span style="color:#B07D48">s</span><span style="color:#999999">.</span><span style="color:#59873A">endsWith</span><span style="color:#999999">(</span><span style="color:#B5695977">'</span><span style="color:#B56959">"</span><span style="color:#B5695977">'</span><span style="color:#999999">))</span><span style="color:#AB5959"> || </span><span style="color:#999999">(</span><span style="color:#B07D48">s</span><span style="color:#999999">.</span><span style="color:#59873A">startsWith</span><span style="color:#999999">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">'</span><span style="color:#B5695977">"</span><span style="color:#999999">)</span><span style="color:#AB5959"> &#x26;&#x26; </span><span style="color:#B07D48">s</span><span style="color:#999999">.</span><span style="color:#59873A">endsWith</span><span style="color:#999999">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">'</span><span style="color:#B5695977">"</span><span style="color:#999999">))</span></span>
<span class="line"><span style="color:#AB5959">      ? </span><span style="color:#B07D48">s</span><span style="color:#999999">.</span><span style="color:#59873A">slice</span><span style="color:#999999">(</span><span style="color:#2F798A">1</span><span style="color:#999999">,</span><span style="color:#AB5959"> -</span><span style="color:#2F798A">1</span><span style="color:#999999">)</span></span>
<span class="line"><span style="color:#AB5959">      : </span><span style="color:#B07D48">s</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#1E754F">  return</span><span style="color:#B07D48"> unquoted</span><span style="color:#999999">.</span><span style="color:#59873A">startsWith</span><span style="color:#999999">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">@</span><span style="color:#B5695977">"</span><span style="color:#999999">)</span><span style="color:#AB5959"> ? </span><span style="color:#B07D48">unquoted</span><span style="color:#999999">.</span><span style="color:#59873A">slice</span><span style="color:#999999">(</span><span style="color:#2F798A">1</span><span style="color:#999999">)</span><span style="color:#AB5959"> : </span><span style="color:#B07D48">unquoted</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#999999">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959">const </span><span style="color:#59873A">escapeRe</span><span style="color:#999999"> =</span><span style="color:#999999"> (</span><span style="color:#B07D48">s</span><span style="color:#999999">: </span><span style="color:#2E8F82">string</span><span style="color:#999999">)</span><span style="color:#999999"> =></span><span style="color:#B07D48"> s</span><span style="color:#999999">.</span><span style="color:#59873A">replace</span><span style="color:#999999">(</span><span style="color:#B5695977">/</span><span style="color:#999999">[</span><span style="color:#5A6AA6">.</span><span style="color:#A65E2B">*+?^${}()|[</span><span style="color:#BDA437">\]\\</span><span style="color:#999999">]</span><span style="color:#B5695977">/</span><span style="color:#1E754F">g</span><span style="color:#999999">,</span><span style="color:#B5695977"> "</span><span style="color:#A65E2B">\\</span><span style="color:#B56959">$&#x26;</span><span style="color:#B5695977">"</span><span style="color:#999999">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959">const </span><span style="color:#59873A">sectionBody</span><span style="color:#999999"> =</span><span style="color:#999999"> (</span><span style="color:#B07D48">md</span><span style="color:#999999">: </span><span style="color:#2E8F82">string</span><span style="color:#999999">,</span><span style="color:#B07D48"> title</span><span style="color:#999999">: </span><span style="color:#2E8F82">string</span><span style="color:#999999">)</span><span style="color:#999999"> =></span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#AB5959">  const </span><span style="color:#B07D48">re</span><span style="color:#999999"> =</span><span style="color:#AB5959"> new </span><span style="color:#59873A">RegExp</span><span style="color:#999999">(</span></span>
<span class="line"><span style="color:#B5695977">    `</span><span style="color:#B56959">^#{1,6}</span><span style="color:#A65E2B">\\</span><span style="color:#B56959">s+</span><span style="color:#1E754F">${</span><span style="color:#59873A">escapeRe</span><span style="color:#999999">(</span><span style="color:#B56959">title</span><span style="color:#999999">)</span><span style="color:#1E754F">}</span><span style="color:#A65E2B">\\</span><span style="color:#B56959">s*$</span><span style="color:#A65E2B">\\</span><span style="color:#B56959">r?</span><span style="color:#A65E2B">\\</span><span style="color:#B56959">n([</span><span style="color:#A65E2B">\\</span><span style="color:#B56959">s</span><span style="color:#A65E2B">\\</span><span style="color:#B56959">S]*?)(?=^#{1,6}</span><span style="color:#A65E2B">\\</span><span style="color:#B56959">s+|</span><span style="color:#A65E2B">\\</span><span style="color:#B56959">Z)</span><span style="color:#B5695977">`</span><span style="color:#999999">,</span></span>
<span class="line"><span style="color:#B5695977">    "</span><span style="color:#B56959">im</span><span style="color:#B5695977">"</span><span style="color:#999999">,</span></span>
<span class="line"><span style="color:#999999">  );</span></span>
<span class="line"><span style="color:#AB5959">  const </span><span style="color:#B07D48">m</span><span style="color:#999999"> =</span><span style="color:#B07D48"> re</span><span style="color:#999999">.</span><span style="color:#59873A">exec</span><span style="color:#999999">(</span><span style="color:#B07D48">md</span><span style="color:#999999">);</span></span>
<span class="line"><span style="color:#1E754F">  return</span><span style="color:#B07D48"> m</span><span style="color:#AB5959"> ? </span><span style="color:#B07D48">m</span><span style="color:#999999">[</span><span style="color:#2F798A">1</span><span style="color:#999999">].</span><span style="color:#59873A">trim</span><span style="color:#999999">()</span><span style="color:#AB5959"> : null</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#999999">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F">export</span><span style="color:#AB5959"> const </span><span style="color:#59873A">lintPrompt</span><span style="color:#999999"> =</span><span style="color:#999999"> (</span><span style="color:#B07D48">md</span><span style="color:#999999">: </span><span style="color:#2E8F82">string</span><span style="color:#999999">)</span><span style="color:#999999"> =></span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#AB5959">  const </span><span style="color:#B07D48">errors</span><span style="color:#999999">: </span><span style="color:#2E8F82">string</span><span style="color:#999999">[] =</span><span style="color:#999999"> [];</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F">  for</span><span style="color:#999999"> (</span><span style="color:#AB5959">const </span><span style="color:#B07D48">s</span><span style="color:#AB5959"> of </span><span style="color:#B07D48">REQUIRED_SECTIONS</span><span style="color:#999999">)</span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#1E754F">    if</span><span style="color:#999999"> (</span><span style="color:#59873A">sectionBody</span><span style="color:#999999">(</span><span style="color:#B07D48">md</span><span style="color:#999999">,</span><span style="color:#B07D48"> s</span><span style="color:#999999">)</span><span style="color:#AB5959"> === null</span><span style="color:#999999">)</span><span style="color:#B07D48"> errors</span><span style="color:#999999">.</span><span style="color:#59873A">push</span><span style="color:#999999">(</span><span style="color:#B5695977">`</span><span style="color:#B56959">Missing section heading: </span><span style="color:#1E754F">${</span><span style="color:#B56959">s</span><span style="color:#1E754F">}</span><span style="color:#B5695977">`</span><span style="color:#999999">);</span></span>
<span class="line"><span style="color:#999999">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F">  for</span><span style="color:#999999"> (</span><span style="color:#AB5959">const </span><span style="color:#B07D48">s</span><span style="color:#AB5959"> of </span><span style="color:#B07D48">REQUIRED_NONEMPTY</span><span style="color:#999999">)</span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#AB5959">    const </span><span style="color:#B07D48">body</span><span style="color:#999999"> =</span><span style="color:#59873A"> sectionBody</span><span style="color:#999999">(</span><span style="color:#B07D48">md</span><span style="color:#999999">,</span><span style="color:#B07D48"> s</span><span style="color:#999999">);</span></span>
<span class="line"><span style="color:#1E754F">    if</span><span style="color:#999999"> (</span><span style="color:#B07D48">body</span><span style="color:#AB5959"> !== null &#x26;&#x26; !</span><span style="color:#B07D48">body</span><span style="color:#999999">)</span><span style="color:#B07D48"> errors</span><span style="color:#999999">.</span><span style="color:#59873A">push</span><span style="color:#999999">(</span><span style="color:#B5695977">`</span><span style="color:#B56959">Section must not be empty: </span><span style="color:#1E754F">${</span><span style="color:#B56959">s</span><span style="color:#1E754F">}</span><span style="color:#B5695977">`</span><span style="color:#999999">);</span></span>
<span class="line"><span style="color:#999999">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F">  return</span><span style="color:#B07D48"> errors</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#999999">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F">export</span><span style="color:#AB5959"> const </span><span style="color:#59873A">loadJson</span><span style="color:#999999"> =</span><span style="color:#AB5959"> async </span><span style="color:#999999">&#x3C;</span><span style="color:#2E8F82">T</span><span style="color:#999999">>(</span><span style="color:#B07D48">filePath</span><span style="color:#999999">: </span><span style="color:#2E8F82">string</span><span style="color:#999999">,</span><span style="color:#B07D48"> fallback</span><span style="color:#999999">: </span><span style="color:#2E8F82">T</span><span style="color:#999999">):</span><span style="color:#2E8F82"> Promise</span><span style="color:#999999">&#x3C;</span><span style="color:#2E8F82">T</span><span style="color:#999999">></span><span style="color:#999999"> =></span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#1E754F">  try</span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#1E754F">    return</span><span style="color:#B07D48"> JSON</span><span style="color:#999999">.</span><span style="color:#59873A">parse</span><span style="color:#999999">(</span><span style="color:#1E754F">await</span><span style="color:#B07D48"> fs</span><span style="color:#999999">.</span><span style="color:#59873A">readFile</span><span style="color:#999999">(</span><span style="color:#B07D48">filePath</span><span style="color:#999999">,</span><span style="color:#B5695977"> "</span><span style="color:#B56959">utf8</span><span style="color:#B5695977">"</span><span style="color:#999999">))</span><span style="color:#1E754F"> as</span><span style="color:#2E8F82"> T</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#999999">  }</span><span style="color:#1E754F"> catch</span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#1E754F">    return</span><span style="color:#B07D48"> fallback</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#999999">  }</span></span>
<span class="line"><span style="color:#999999">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F">export</span><span style="color:#AB5959"> const </span><span style="color:#59873A">saveJson</span><span style="color:#999999"> =</span><span style="color:#AB5959"> async </span><span style="color:#999999">(</span><span style="color:#B07D48">filePath</span><span style="color:#999999">: </span><span style="color:#2E8F82">string</span><span style="color:#999999">,</span><span style="color:#B07D48"> value</span><span style="color:#999999">: </span><span style="color:#2E8F82">unknown</span><span style="color:#999999">)</span><span style="color:#999999"> =></span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#1E754F">  await</span><span style="color:#B07D48"> fs</span><span style="color:#999999">.</span><span style="color:#59873A">mkdir</span><span style="color:#999999">(</span><span style="color:#B07D48">path</span><span style="color:#999999">.</span><span style="color:#59873A">dirname</span><span style="color:#999999">(</span><span style="color:#B07D48">filePath</span><span style="color:#999999">),</span><span style="color:#999999"> { </span><span style="color:#998418">recursive</span><span style="color:#999999">: </span><span style="color:#1E754F">true</span><span style="color:#999999"> });</span></span>
<span class="line"><span style="color:#1E754F">  await</span><span style="color:#B07D48"> fs</span><span style="color:#999999">.</span><span style="color:#59873A">writeFile</span><span style="color:#999999">(</span><span style="color:#B07D48">filePath</span><span style="color:#999999">,</span><span style="color:#B5695977"> `</span><span style="color:#1E754F">${</span><span style="color:#B56959">JSON</span><span style="color:#999999">.</span><span style="color:#59873A">stringify</span><span style="color:#999999">(</span><span style="color:#B56959">value</span><span style="color:#999999">,</span><span style="color:#AB5959"> null</span><span style="color:#999999">,</span><span style="color:#2F798A"> 2</span><span style="color:#999999">)</span><span style="color:#1E754F">}</span><span style="color:#A65E2B">\n</span><span style="color:#B5695977">`</span><span style="color:#999999">,</span><span style="color:#B5695977"> "</span><span style="color:#B56959">utf8</span><span style="color:#B5695977">"</span><span style="color:#999999">);</span></span>
<span class="line"><span style="color:#999999">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959">type</span><span style="color:#2E8F82"> TextPartLike</span><span style="color:#999999"> =</span><span style="color:#999999"> {</span><span style="color:#B07D48"> type</span><span style="color:#999999">: </span><span style="color:#B5695977">"</span><span style="color:#B56959">text</span><span style="color:#B5695977">"</span><span style="color:#999999">;</span><span style="color:#B07D48"> text</span><span style="color:#999999">: </span><span style="color:#2E8F82">string</span><span style="color:#999999"> };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F">export</span><span style="color:#AB5959"> const </span><span style="color:#59873A">textFromParts</span><span style="color:#999999"> =</span><span style="color:#999999"> (</span><span style="color:#B07D48">parts</span><span style="color:#999999">: </span><span style="color:#2E8F82">unknown</span><span style="color:#999999">[])</span><span style="color:#999999"> =></span></span>
<span class="line"><span style="color:#999999">  (</span><span style="color:#B07D48">Array</span><span style="color:#999999">.</span><span style="color:#59873A">isArray</span><span style="color:#999999">(</span><span style="color:#B07D48">parts</span><span style="color:#999999">)</span><span style="color:#AB5959"> ? </span><span style="color:#B07D48">parts</span><span style="color:#AB5959"> : </span><span style="color:#999999">[])</span></span>
<span class="line"><span style="color:#999999">    .</span><span style="color:#59873A">filter</span><span style="color:#999999">((</span><span style="color:#B07D48">p</span><span style="color:#999999">):</span><span style="color:#B07D48"> p</span><span style="color:#AB5959"> is</span><span style="color:#2E8F82"> TextPartLike</span><span style="color:#999999"> =></span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#1E754F">      if</span><span style="color:#999999"> (</span><span style="color:#AB5959">typeof</span><span style="color:#B07D48"> p</span><span style="color:#AB5959"> !==</span><span style="color:#B5695977"> "</span><span style="color:#B56959">object</span><span style="color:#B5695977">"</span><span style="color:#AB5959"> ||</span><span style="color:#B07D48"> p</span><span style="color:#AB5959"> ===</span><span style="color:#AB5959"> null</span><span style="color:#999999">)</span><span style="color:#1E754F"> return</span><span style="color:#1E754F"> false</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#AB5959">      const </span><span style="color:#B07D48">candidate</span><span style="color:#999999"> =</span><span style="color:#B07D48"> p</span><span style="color:#1E754F"> as</span><span style="color:#999999"> {</span><span style="color:#B07D48"> type</span><span style="color:#AB5959">?</span><span style="color:#999999">: </span><span style="color:#2E8F82">unknown</span><span style="color:#999999">;</span><span style="color:#B07D48"> text</span><span style="color:#AB5959">?</span><span style="color:#999999">: </span><span style="color:#2E8F82">unknown</span><span style="color:#999999"> };</span></span>
<span class="line"><span style="color:#1E754F">      return</span><span style="color:#B07D48"> candidate</span><span style="color:#999999">.</span><span style="color:#B07D48">type</span><span style="color:#AB5959"> ===</span><span style="color:#B5695977"> "</span><span style="color:#B56959">text</span><span style="color:#B5695977">"</span><span style="color:#AB5959"> &#x26;&#x26;</span><span style="color:#AB5959"> typeof</span><span style="color:#B07D48"> candidate</span><span style="color:#999999">.</span><span style="color:#B07D48">text</span><span style="color:#AB5959"> ===</span><span style="color:#B5695977"> "</span><span style="color:#B56959">string</span><span style="color:#B5695977">"</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#999999">    })</span></span>
<span class="line"><span style="color:#999999">    .</span><span style="color:#59873A">map</span><span style="color:#999999">((</span><span style="color:#B07D48">p</span><span style="color:#999999">)</span><span style="color:#999999"> =></span><span style="color:#B07D48"> p</span><span style="color:#999999">.</span><span style="color:#B07D48">text</span><span style="color:#999999">)</span></span>
<span class="line"><span style="color:#999999">    .</span><span style="color:#59873A">join</span><span style="color:#999999">(</span><span style="color:#B5695977">"</span><span style="color:#A65E2B">\n</span><span style="color:#B5695977">"</span><span style="color:#999999">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F">export</span><span style="color:#AB5959"> const </span><span style="color:#59873A">hasDone</span><span style="color:#999999"> =</span><span style="color:#999999"> (</span><span style="color:#B07D48">text</span><span style="color:#999999">: </span><span style="color:#2E8F82">string</span><span style="color:#999999">)</span><span style="color:#999999"> =></span></span>
<span class="line"><span style="color:#59873A">  String</span><span style="color:#999999">(</span><span style="color:#B07D48">text</span><span style="color:#999999">)</span></span>
<span class="line"><span style="color:#999999">    .</span><span style="color:#59873A">split</span><span style="color:#999999">(</span><span style="color:#B5695977">/</span><span style="color:#5A6AA6">\r</span><span style="color:#2F798A">?</span><span style="color:#5A6AA6">\n</span><span style="color:#B5695977">/</span><span style="color:#999999">)</span></span>
<span class="line"><span style="color:#999999">    .</span><span style="color:#59873A">some</span><span style="color:#999999">((</span><span style="color:#B07D48">l</span><span style="color:#999999">)</span><span style="color:#999999"> =></span><span style="color:#B07D48"> l</span><span style="color:#999999">.</span><span style="color:#59873A">trim</span><span style="color:#999999">()</span><span style="color:#AB5959"> ===</span><span style="color:#B07D48"> DONE_TOKEN</span><span style="color:#999999">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F">export</span><span style="color:#AB5959"> const </span><span style="color:#59873A">parseControl</span><span style="color:#999999"> =</span><span style="color:#999999"> (</span><span style="color:#B07D48">text</span><span style="color:#999999">: </span><span style="color:#2E8F82">string</span><span style="color:#999999">)</span><span style="color:#999999"> =></span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#AB5959">  const </span><span style="color:#B07D48">line</span><span style="color:#999999"> =</span><span style="color:#59873A"> String</span><span style="color:#999999">(</span><span style="color:#B07D48">text</span><span style="color:#999999">)</span></span>
<span class="line"><span style="color:#999999">    .</span><span style="color:#59873A">split</span><span style="color:#999999">(</span><span style="color:#B5695977">/</span><span style="color:#5A6AA6">\r</span><span style="color:#2F798A">?</span><span style="color:#5A6AA6">\n</span><span style="color:#B5695977">/</span><span style="color:#999999">)</span></span>
<span class="line"><span style="color:#999999">    .</span><span style="color:#59873A">map</span><span style="color:#999999">((</span><span style="color:#B07D48">l</span><span style="color:#999999">)</span><span style="color:#999999"> =></span><span style="color:#B07D48"> l</span><span style="color:#999999">.</span><span style="color:#59873A">trim</span><span style="color:#999999">())</span></span>
<span class="line"><span style="color:#999999">    .</span><span style="color:#59873A">find</span><span style="color:#999999">((</span><span style="color:#B07D48">l</span><span style="color:#999999">)</span><span style="color:#999999"> =></span><span style="color:#B07D48"> l</span><span style="color:#999999">.</span><span style="color:#59873A">startsWith</span><span style="color:#999999">(</span><span style="color:#B07D48">CONTROL_PREFIX</span><span style="color:#999999">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F">  if</span><span style="color:#999999"> (</span><span style="color:#AB5959">!</span><span style="color:#B07D48">line</span><span style="color:#999999">)</span><span style="color:#1E754F"> return</span><span style="color:#AB5959"> null</span><span style="color:#999999">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F">  try</span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#1E754F">    return</span><span style="color:#B07D48"> JSON</span><span style="color:#999999">.</span><span style="color:#59873A">parse</span><span style="color:#999999">(</span><span style="color:#B07D48">line</span><span style="color:#999999">.</span><span style="color:#59873A">slice</span><span style="color:#999999">(</span><span style="color:#B07D48">CONTROL_PREFIX</span><span style="color:#999999">.</span><span style="color:#998418">length</span><span style="color:#999999">).</span><span style="color:#59873A">trim</span><span style="color:#999999">())</span><span style="color:#1E754F"> as</span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#B07D48">      arg1</span><span style="color:#AB5959">?</span><span style="color:#999999">: </span><span style="color:#2E8F82">unknown</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#B07D48">      arg2</span><span style="color:#AB5959">?</span><span style="color:#999999">: </span><span style="color:#2E8F82">unknown</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#B07D48">      arg3</span><span style="color:#AB5959">?</span><span style="color:#999999">: </span><span style="color:#2E8F82">unknown</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#999999">    };</span></span>
<span class="line"><span style="color:#999999">  }</span><span style="color:#1E754F"> catch</span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#1E754F">    return</span><span style="color:#AB5959"> null</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#999999">  }</span></span>
<span class="line"><span style="color:#999999">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F">export</span><span style="color:#AB5959"> const </span><span style="color:#59873A">tokenize</span><span style="color:#999999"> =</span><span style="color:#999999"> (</span><span style="color:#B07D48">cmd</span><span style="color:#999999">: </span><span style="color:#2E8F82">string</span><span style="color:#999999">)</span><span style="color:#999999"> =></span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#AB5959">  const </span><span style="color:#B07D48">out</span><span style="color:#999999">: </span><span style="color:#2E8F82">string</span><span style="color:#999999">[] =</span><span style="color:#999999"> [];</span></span>
<span class="line"><span style="color:#AB5959">  let </span><span style="color:#B07D48">cur</span><span style="color:#999999"> =</span><span style="color:#B5695977"> ""</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#AB5959">  let </span><span style="color:#B07D48">q</span><span style="color:#999999">: </span><span style="color:#B5695977">'</span><span style="color:#B56959">"</span><span style="color:#B5695977">'</span><span style="color:#999999"> | </span><span style="color:#B5695977">"</span><span style="color:#B56959">'</span><span style="color:#B5695977">"</span><span style="color:#999999"> | </span><span style="color:#AB5959">null</span><span style="color:#999999"> =</span><span style="color:#AB5959"> null</span><span style="color:#999999">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F">  for</span><span style="color:#999999"> (</span><span style="color:#AB5959">let </span><span style="color:#B07D48">i</span><span style="color:#999999"> =</span><span style="color:#2F798A"> 0</span><span style="color:#999999">;</span><span style="color:#B07D48"> i</span><span style="color:#999999"> &#x3C;</span><span style="color:#B07D48"> cmd</span><span style="color:#999999">.</span><span style="color:#998418">length</span><span style="color:#999999">;</span><span style="color:#B07D48"> i</span><span style="color:#AB5959">++</span><span style="color:#999999">)</span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#AB5959">    const </span><span style="color:#B07D48">c</span><span style="color:#999999"> =</span><span style="color:#B07D48"> cmd</span><span style="color:#999999">[</span><span style="color:#B07D48">i</span><span style="color:#999999">];</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F">    if</span><span style="color:#999999"> (</span><span style="color:#B07D48">q</span><span style="color:#999999">)</span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#1E754F">      if</span><span style="color:#999999"> (</span><span style="color:#B07D48">c</span><span style="color:#AB5959"> === </span><span style="color:#B07D48">q</span><span style="color:#999999">)</span><span style="color:#B07D48"> q</span><span style="color:#999999"> =</span><span style="color:#AB5959"> null</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#1E754F">      else</span><span style="color:#B07D48"> cur</span><span style="color:#AB5959"> += </span><span style="color:#B07D48">c</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#1E754F">      continue</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#999999">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F">    if</span><span style="color:#999999"> (</span><span style="color:#B07D48">c</span><span style="color:#AB5959"> === </span><span style="color:#B5695977">'</span><span style="color:#B56959">"</span><span style="color:#B5695977">'</span><span style="color:#AB5959"> || </span><span style="color:#B07D48">c</span><span style="color:#AB5959"> === </span><span style="color:#B5695977">"</span><span style="color:#B56959">'</span><span style="color:#B5695977">"</span><span style="color:#999999">)</span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#B07D48">      q</span><span style="color:#999999"> =</span><span style="color:#B07D48"> c</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#1E754F">      continue</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#999999">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F">    if</span><span style="color:#999999"> (</span><span style="color:#B5695977">/</span><span style="color:#5A6AA6">\s</span><span style="color:#B5695977">/</span><span style="color:#999999">.</span><span style="color:#59873A">test</span><span style="color:#999999">(</span><span style="color:#B07D48">c</span><span style="color:#999999">))</span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#1E754F">      if</span><span style="color:#999999"> (</span><span style="color:#B07D48">cur</span><span style="color:#999999">)</span><span style="color:#B07D48"> out</span><span style="color:#999999">.</span><span style="color:#59873A">push</span><span style="color:#999999">(</span><span style="color:#B07D48">cur</span><span style="color:#999999">);</span></span>
<span class="line"><span style="color:#B07D48">      cur</span><span style="color:#999999"> =</span><span style="color:#B5695977"> ""</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#1E754F">      continue</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#999999">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B07D48">    cur</span><span style="color:#AB5959"> += </span><span style="color:#B07D48">c</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#999999">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F">  if</span><span style="color:#999999"> (</span><span style="color:#B07D48">cur</span><span style="color:#999999">)</span><span style="color:#B07D48"> out</span><span style="color:#999999">.</span><span style="color:#59873A">push</span><span style="color:#999999">(</span><span style="color:#B07D48">cur</span><span style="color:#999999">);</span></span>
<span class="line"><span style="color:#1E754F">  return</span><span style="color:#B07D48"> out</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#999999">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F">export</span><span style="color:#AB5959"> const </span><span style="color:#59873A">normalizeRelToken</span><span style="color:#999999"> =</span><span style="color:#999999"> (</span><span style="color:#B07D48">t</span><span style="color:#999999">: </span><span style="color:#2E8F82">string</span><span style="color:#999999">)</span><span style="color:#999999"> =></span></span>
<span class="line"><span style="color:#59873A">  String</span><span style="color:#999999">(</span><span style="color:#B07D48">t</span><span style="color:#999999">).</span><span style="color:#59873A">replace</span><span style="color:#999999">(</span><span style="color:#B5695977">/</span><span style="color:#BDA437">\\</span><span style="color:#B5695977">/</span><span style="color:#1E754F">g</span><span style="color:#999999">,</span><span style="color:#B5695977"> "</span><span style="color:#B56959">/</span><span style="color:#B5695977">"</span><span style="color:#999999">).</span><span style="color:#59873A">replace</span><span style="color:#999999">(</span><span style="color:#B5695977">/</span><span style="color:#1E754F">^</span><span style="color:#BDA437">\.\/</span><span style="color:#B5695977">/</span><span style="color:#999999">,</span><span style="color:#B5695977"> ""</span><span style="color:#999999">).</span><span style="color:#59873A">trim</span><span style="color:#999999">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F">export</span><span style="color:#AB5959"> const </span><span style="color:#59873A">splitShellSegments</span><span style="color:#999999"> =</span><span style="color:#999999"> (</span><span style="color:#B07D48">command</span><span style="color:#999999">: </span><span style="color:#2E8F82">string</span><span style="color:#999999">)</span><span style="color:#999999"> =></span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#AB5959">  const </span><span style="color:#B07D48">segments</span><span style="color:#999999">: </span><span style="color:#2E8F82">string</span><span style="color:#999999">[] =</span><span style="color:#999999"> [];</span></span>
<span class="line"><span style="color:#AB5959">  let </span><span style="color:#B07D48">cur</span><span style="color:#999999"> =</span><span style="color:#B5695977"> ""</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#AB5959">  let </span><span style="color:#B07D48">q</span><span style="color:#999999">: </span><span style="color:#B5695977">'</span><span style="color:#B56959">"</span><span style="color:#B5695977">'</span><span style="color:#999999"> | </span><span style="color:#B5695977">"</span><span style="color:#B56959">'</span><span style="color:#B5695977">"</span><span style="color:#999999"> | </span><span style="color:#AB5959">null</span><span style="color:#999999"> =</span><span style="color:#AB5959"> null</span><span style="color:#999999">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959">  const </span><span style="color:#59873A">flush</span><span style="color:#999999"> =</span><span style="color:#999999"> ()</span><span style="color:#999999"> =></span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#AB5959">    const </span><span style="color:#B07D48">trimmed</span><span style="color:#999999"> =</span><span style="color:#B07D48"> cur</span><span style="color:#999999">.</span><span style="color:#59873A">trim</span><span style="color:#999999">();</span></span>
<span class="line"><span style="color:#1E754F">    if</span><span style="color:#999999"> (</span><span style="color:#B07D48">trimmed</span><span style="color:#999999">)</span><span style="color:#B07D48"> segments</span><span style="color:#999999">.</span><span style="color:#59873A">push</span><span style="color:#999999">(</span><span style="color:#B07D48">trimmed</span><span style="color:#999999">);</span></span>
<span class="line"><span style="color:#B07D48">    cur</span><span style="color:#999999"> =</span><span style="color:#B5695977"> ""</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#999999">  };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F">  for</span><span style="color:#999999"> (</span><span style="color:#AB5959">let </span><span style="color:#B07D48">i</span><span style="color:#999999"> =</span><span style="color:#2F798A"> 0</span><span style="color:#999999">;</span><span style="color:#B07D48"> i</span><span style="color:#999999"> &#x3C;</span><span style="color:#B07D48"> command</span><span style="color:#999999">.</span><span style="color:#998418">length</span><span style="color:#999999">;</span><span style="color:#B07D48"> i</span><span style="color:#AB5959">++</span><span style="color:#999999">)</span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#AB5959">    const </span><span style="color:#B07D48">c</span><span style="color:#999999"> =</span><span style="color:#B07D48"> command</span><span style="color:#999999">[</span><span style="color:#B07D48">i</span><span style="color:#999999">];</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F">    if</span><span style="color:#999999"> (</span><span style="color:#B07D48">q</span><span style="color:#999999">)</span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#1E754F">      if</span><span style="color:#999999"> (</span><span style="color:#B07D48">c</span><span style="color:#AB5959"> === </span><span style="color:#B07D48">q</span><span style="color:#999999">)</span><span style="color:#B07D48"> q</span><span style="color:#999999"> =</span><span style="color:#AB5959"> null</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#B07D48">      cur</span><span style="color:#AB5959"> += </span><span style="color:#B07D48">c</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#1E754F">      continue</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#999999">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F">    if</span><span style="color:#999999"> (</span><span style="color:#B07D48">c</span><span style="color:#AB5959"> === </span><span style="color:#B5695977">'</span><span style="color:#B56959">"</span><span style="color:#B5695977">'</span><span style="color:#AB5959"> || </span><span style="color:#B07D48">c</span><span style="color:#AB5959"> === </span><span style="color:#B5695977">"</span><span style="color:#B56959">'</span><span style="color:#B5695977">"</span><span style="color:#999999">)</span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#B07D48">      q</span><span style="color:#999999"> =</span><span style="color:#B07D48"> c</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#B07D48">      cur</span><span style="color:#AB5959"> += </span><span style="color:#B07D48">c</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#1E754F">      continue</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#999999">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A0ADA0">    // Split on unquoted ;, &#x26;&#x26;, ||, and newlines.</span></span>
<span class="line"><span style="color:#1E754F">    if</span><span style="color:#999999"> (</span><span style="color:#B07D48">c</span><span style="color:#AB5959"> === </span><span style="color:#B5695977">"</span><span style="color:#B56959">;</span><span style="color:#B5695977">"</span><span style="color:#AB5959"> || </span><span style="color:#B07D48">c</span><span style="color:#AB5959"> === </span><span style="color:#B5695977">"</span><span style="color:#A65E2B">\n</span><span style="color:#B5695977">"</span><span style="color:#999999">)</span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#59873A">      flush</span><span style="color:#999999">();</span></span>
<span class="line"><span style="color:#1E754F">      continue</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#999999">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F">    if</span><span style="color:#999999"> (</span><span style="color:#B07D48">c</span><span style="color:#AB5959"> === </span><span style="color:#B5695977">"</span><span style="color:#B56959">&#x26;</span><span style="color:#B5695977">"</span><span style="color:#AB5959"> &#x26;&#x26; </span><span style="color:#B07D48">command</span><span style="color:#999999">[</span><span style="color:#B07D48">i</span><span style="color:#AB5959"> + </span><span style="color:#2F798A">1</span><span style="color:#999999">]</span><span style="color:#AB5959"> === </span><span style="color:#B5695977">"</span><span style="color:#B56959">&#x26;</span><span style="color:#B5695977">"</span><span style="color:#999999">)</span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#59873A">      flush</span><span style="color:#999999">();</span></span>
<span class="line"><span style="color:#B07D48">      i</span><span style="color:#AB5959">++</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#1E754F">      continue</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#999999">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F">    if</span><span style="color:#999999"> (</span><span style="color:#B07D48">c</span><span style="color:#AB5959"> === </span><span style="color:#B5695977">"</span><span style="color:#B56959">|</span><span style="color:#B5695977">"</span><span style="color:#AB5959"> &#x26;&#x26; </span><span style="color:#B07D48">command</span><span style="color:#999999">[</span><span style="color:#B07D48">i</span><span style="color:#AB5959"> + </span><span style="color:#2F798A">1</span><span style="color:#999999">]</span><span style="color:#AB5959"> === </span><span style="color:#B5695977">"</span><span style="color:#B56959">|</span><span style="color:#B5695977">"</span><span style="color:#999999">)</span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#59873A">      flush</span><span style="color:#999999">();</span></span>
<span class="line"><span style="color:#B07D48">      i</span><span style="color:#AB5959">++</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#1E754F">      continue</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#999999">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B07D48">    cur</span><span style="color:#AB5959"> += </span><span style="color:#B07D48">c</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#999999">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#59873A">  flush</span><span style="color:#999999">();</span></span>
<span class="line"><span style="color:#1E754F">  return</span><span style="color:#B07D48"> segments</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#999999">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959">const </span><span style="color:#B07D48">envAssignmentRe</span><span style="color:#999999"> =</span><span style="color:#B5695977"> /</span><span style="color:#1E754F">^</span><span style="color:#999999">[</span><span style="color:#A65E2B">A-Za-z_</span><span style="color:#999999">][</span><span style="color:#A65E2B">A-Za-z0-9_</span><span style="color:#999999">]</span><span style="color:#2F798A">*</span><span style="color:#AB5E3F">=</span><span style="color:#5A6AA6">.</span><span style="color:#2F798A">*</span><span style="color:#B5695977">/</span><span style="color:#999999">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F">export</span><span style="color:#AB5959"> const </span><span style="color:#59873A">stripEnvPrefixes</span><span style="color:#999999"> =</span><span style="color:#999999"> (</span><span style="color:#B07D48">tokens</span><span style="color:#999999">: </span><span style="color:#2E8F82">string</span><span style="color:#999999">[])</span><span style="color:#999999"> =></span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#AB5959">  let </span><span style="color:#B07D48">i</span><span style="color:#999999"> =</span><span style="color:#2F798A"> 0</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#1E754F">  if</span><span style="color:#999999"> (</span><span style="color:#B07D48">tokens</span><span style="color:#999999">[</span><span style="color:#B07D48">i</span><span style="color:#999999">]</span><span style="color:#AB5959"> === </span><span style="color:#B5695977">"</span><span style="color:#B56959">env</span><span style="color:#B5695977">"</span><span style="color:#999999">)</span><span style="color:#B07D48"> i</span><span style="color:#AB5959">++</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#1E754F">  while</span><span style="color:#999999"> (</span><span style="color:#B07D48">i</span><span style="color:#999999"> &#x3C;</span><span style="color:#B07D48"> tokens</span><span style="color:#999999">.</span><span style="color:#998418">length</span><span style="color:#AB5959"> &#x26;&#x26; </span><span style="color:#B07D48">envAssignmentRe</span><span style="color:#999999">.</span><span style="color:#59873A">test</span><span style="color:#999999">(</span><span style="color:#B07D48">tokens</span><span style="color:#999999">[</span><span style="color:#B07D48">i</span><span style="color:#999999">]</span><span style="color:#AB5959"> ?? </span><span style="color:#B5695977">""</span><span style="color:#999999">))</span><span style="color:#B07D48"> i</span><span style="color:#AB5959">++</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#1E754F">  return</span><span style="color:#B07D48"> tokens</span><span style="color:#999999">.</span><span style="color:#59873A">slice</span><span style="color:#999999">(</span><span style="color:#B07D48">i</span><span style="color:#999999">);</span></span>
<span class="line"><span style="color:#999999">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F">export</span><span style="color:#AB5959"> const </span><span style="color:#59873A">rmTargetsFromArgs</span><span style="color:#999999"> =</span><span style="color:#999999"> (</span><span style="color:#B07D48">args</span><span style="color:#999999">: </span><span style="color:#2E8F82">string</span><span style="color:#999999">[])</span><span style="color:#999999"> =></span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#AB5959">  const </span><span style="color:#B07D48">targets</span><span style="color:#999999">: </span><span style="color:#2E8F82">string</span><span style="color:#999999">[] =</span><span style="color:#999999"> [];</span></span>
<span class="line"><span style="color:#AB5959">  let </span><span style="color:#B07D48">passthrough</span><span style="color:#999999"> =</span><span style="color:#1E754F"> false</span><span style="color:#999999">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F">  for</span><span style="color:#999999"> (</span><span style="color:#AB5959">const </span><span style="color:#B07D48">a</span><span style="color:#AB5959"> of </span><span style="color:#B07D48">args</span><span style="color:#999999">)</span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#1E754F">    if</span><span style="color:#999999"> (</span><span style="color:#AB5959">!</span><span style="color:#B07D48">passthrough</span><span style="color:#AB5959"> &#x26;&#x26; </span><span style="color:#B07D48">a</span><span style="color:#AB5959"> === </span><span style="color:#B5695977">"</span><span style="color:#B56959">--</span><span style="color:#B5695977">"</span><span style="color:#999999">)</span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#B07D48">      passthrough</span><span style="color:#999999"> =</span><span style="color:#1E754F"> true</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#1E754F">      continue</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#999999">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F">    if</span><span style="color:#999999"> (</span><span style="color:#AB5959">!</span><span style="color:#B07D48">passthrough</span><span style="color:#AB5959"> &#x26;&#x26; </span><span style="color:#B07D48">a</span><span style="color:#999999">.</span><span style="color:#59873A">startsWith</span><span style="color:#999999">(</span><span style="color:#B5695977">"</span><span style="color:#B56959">-</span><span style="color:#B5695977">"</span><span style="color:#999999">))</span><span style="color:#1E754F"> continue</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#B07D48">    targets</span><span style="color:#999999">.</span><span style="color:#59873A">push</span><span style="color:#999999">(</span><span style="color:#B07D48">a</span><span style="color:#999999">);</span></span>
<span class="line"><span style="color:#999999">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#1E754F">  return</span><span style="color:#B07D48"> targets</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#999999">};</span></span>
<span class="line"></span></code></pre>1b:T4f6,// Minimal ambient types to keep .opencode TypeScript self-contained.
// This repo may not have Node/Bun type packages installed.

declare type Buffer = Uint8Array;
declare type BufferEncoding =
  | "ascii"
  | "utf8"
  | "utf-8"
  | "utf16le"
  | "ucs2"
  | "ucs-2"
  | "base64"
  | "base64url"
  | "latin1"
  | "binary"
  | "hex";

type FsStats = {
  isFile(): boolean;
};

type FsPromises = {
  realpath(path: string): Promise<string>;
  stat(path: string): Promise<FsStats>;
  readFile(path: string, encoding: BufferEncoding): Promise<string>;
  mkdir(path: string, options?: { recursive?: boolean }): Promise<string | undefined>;
  writeFile(path: string, data: string, encoding: BufferEncoding): Promise<void>;
};

declare module "fs/promises" {
  const fs: FsPromises;
  export default fs;
}

declare module "node:fs/promises" {
  const fs: FsPromises;
  export default fs;
}

type PathModule = {
  join(...paths: string[]): string;
  isAbsolute(path: string): boolean;
  resolve(...paths: string[]): string;
  relative(from: string, to: string): string;
  dirname(path: string): string;
  sep: string;
};

declare module "path" {
  const path: PathModule;
  export default path;
}

declare module "node:path" {
  const path: PathModule;
  export default path;
}
1c:T2f2b,<pre class="shiki vitesse-light" style="background-color:#ffffff;color:#393a34" tabindex="0"><code><span class="line"><span style="color:#A0ADA0">// Minimal ambient types to keep .opencode TypeScript self-contained.</span></span>
<span class="line"><span style="color:#A0ADA0">// This repo may not have Node/Bun type packages installed.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959">declare</span><span style="color:#AB5959"> type</span><span style="color:#2E8F82"> Buffer</span><span style="color:#999999"> =</span><span style="color:#2E8F82"> Uint8Array</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#AB5959">declare</span><span style="color:#AB5959"> type</span><span style="color:#2E8F82"> BufferEncoding</span><span style="color:#999999"> =</span></span>
<span class="line"><span style="color:#999999">  |</span><span style="color:#B5695977"> "</span><span style="color:#B56959">ascii</span><span style="color:#B5695977">"</span></span>
<span class="line"><span style="color:#999999">  |</span><span style="color:#B5695977"> "</span><span style="color:#B56959">utf8</span><span style="color:#B5695977">"</span></span>
<span class="line"><span style="color:#999999">  |</span><span style="color:#B5695977"> "</span><span style="color:#B56959">utf-8</span><span style="color:#B5695977">"</span></span>
<span class="line"><span style="color:#999999">  |</span><span style="color:#B5695977"> "</span><span style="color:#B56959">utf16le</span><span style="color:#B5695977">"</span></span>
<span class="line"><span style="color:#999999">  |</span><span style="color:#B5695977"> "</span><span style="color:#B56959">ucs2</span><span style="color:#B5695977">"</span></span>
<span class="line"><span style="color:#999999">  |</span><span style="color:#B5695977"> "</span><span style="color:#B56959">ucs-2</span><span style="color:#B5695977">"</span></span>
<span class="line"><span style="color:#999999">  |</span><span style="color:#B5695977"> "</span><span style="color:#B56959">base64</span><span style="color:#B5695977">"</span></span>
<span class="line"><span style="color:#999999">  |</span><span style="color:#B5695977"> "</span><span style="color:#B56959">base64url</span><span style="color:#B5695977">"</span></span>
<span class="line"><span style="color:#999999">  |</span><span style="color:#B5695977"> "</span><span style="color:#B56959">latin1</span><span style="color:#B5695977">"</span></span>
<span class="line"><span style="color:#999999">  |</span><span style="color:#B5695977"> "</span><span style="color:#B56959">binary</span><span style="color:#B5695977">"</span></span>
<span class="line"><span style="color:#999999">  |</span><span style="color:#B5695977"> "</span><span style="color:#B56959">hex</span><span style="color:#B5695977">"</span><span style="color:#999999">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959">type</span><span style="color:#2E8F82"> FsStats</span><span style="color:#999999"> =</span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#59873A">  isFile</span><span style="color:#999999">():</span><span style="color:#2E8F82"> boolean</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#999999">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959">type</span><span style="color:#2E8F82"> FsPromises</span><span style="color:#999999"> =</span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#59873A">  realpath</span><span style="color:#999999">(</span><span style="color:#B07D48">path</span><span style="color:#999999">: </span><span style="color:#2E8F82">string</span><span style="color:#999999">):</span><span style="color:#2E8F82"> Promise</span><span style="color:#999999">&#x3C;</span><span style="color:#2E8F82">string</span><span style="color:#999999">>;</span></span>
<span class="line"><span style="color:#59873A">  stat</span><span style="color:#999999">(</span><span style="color:#B07D48">path</span><span style="color:#999999">: </span><span style="color:#2E8F82">string</span><span style="color:#999999">):</span><span style="color:#2E8F82"> Promise</span><span style="color:#999999">&#x3C;</span><span style="color:#2E8F82">FsStats</span><span style="color:#999999">>;</span></span>
<span class="line"><span style="color:#59873A">  readFile</span><span style="color:#999999">(</span><span style="color:#B07D48">path</span><span style="color:#999999">: </span><span style="color:#2E8F82">string</span><span style="color:#999999">,</span><span style="color:#B07D48"> encoding</span><span style="color:#999999">: </span><span style="color:#2E8F82">BufferEncoding</span><span style="color:#999999">):</span><span style="color:#2E8F82"> Promise</span><span style="color:#999999">&#x3C;</span><span style="color:#2E8F82">string</span><span style="color:#999999">>;</span></span>
<span class="line"><span style="color:#59873A">  mkdir</span><span style="color:#999999">(</span><span style="color:#B07D48">path</span><span style="color:#999999">: </span><span style="color:#2E8F82">string</span><span style="color:#999999">,</span><span style="color:#B07D48"> options</span><span style="color:#AB5959">?</span><span style="color:#999999">: { </span><span style="color:#B07D48">recursive</span><span style="color:#AB5959">?</span><span style="color:#999999">: </span><span style="color:#2E8F82">boolean</span><span style="color:#999999"> }):</span><span style="color:#2E8F82"> Promise</span><span style="color:#999999">&#x3C;</span><span style="color:#2E8F82">string</span><span style="color:#999999"> |</span><span style="color:#AB5959"> undefined</span><span style="color:#999999">>;</span></span>
<span class="line"><span style="color:#59873A">  writeFile</span><span style="color:#999999">(</span><span style="color:#B07D48">path</span><span style="color:#999999">: </span><span style="color:#2E8F82">string</span><span style="color:#999999">,</span><span style="color:#B07D48"> data</span><span style="color:#999999">: </span><span style="color:#2E8F82">string</span><span style="color:#999999">,</span><span style="color:#B07D48"> encoding</span><span style="color:#999999">: </span><span style="color:#2E8F82">BufferEncoding</span><span style="color:#999999">):</span><span style="color:#2E8F82"> Promise</span><span style="color:#999999">&#x3C;</span><span style="color:#2E8F82">void</span><span style="color:#999999">>;</span></span>
<span class="line"><span style="color:#999999">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959">declare</span><span style="color:#AB5959"> module</span><span style="color:#B5695977"> "</span><span style="color:#B56959">fs/promises</span><span style="color:#B5695977">"</span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#AB5959">  const </span><span style="color:#B07D48">fs</span><span style="color:#999999">: </span><span style="color:#2E8F82">FsPromises</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#1E754F">  export</span><span style="color:#1E754F"> default</span><span style="color:#B07D48"> fs</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#999999">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959">declare</span><span style="color:#AB5959"> module</span><span style="color:#B5695977"> "</span><span style="color:#B56959">node:fs/promises</span><span style="color:#B5695977">"</span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#AB5959">  const </span><span style="color:#B07D48">fs</span><span style="color:#999999">: </span><span style="color:#2E8F82">FsPromises</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#1E754F">  export</span><span style="color:#1E754F"> default</span><span style="color:#B07D48"> fs</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#999999">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959">type</span><span style="color:#2E8F82"> PathModule</span><span style="color:#999999"> =</span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#59873A">  join</span><span style="color:#999999">(...</span><span style="color:#B07D48">paths</span><span style="color:#999999">: </span><span style="color:#2E8F82">string</span><span style="color:#999999">[]):</span><span style="color:#2E8F82"> string</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#59873A">  isAbsolute</span><span style="color:#999999">(</span><span style="color:#B07D48">path</span><span style="color:#999999">: </span><span style="color:#2E8F82">string</span><span style="color:#999999">):</span><span style="color:#2E8F82"> boolean</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#59873A">  resolve</span><span style="color:#999999">(...</span><span style="color:#B07D48">paths</span><span style="color:#999999">: </span><span style="color:#2E8F82">string</span><span style="color:#999999">[]):</span><span style="color:#2E8F82"> string</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#59873A">  relative</span><span style="color:#999999">(</span><span style="color:#B07D48">from</span><span style="color:#999999">: </span><span style="color:#2E8F82">string</span><span style="color:#999999">,</span><span style="color:#B07D48"> to</span><span style="color:#999999">: </span><span style="color:#2E8F82">string</span><span style="color:#999999">):</span><span style="color:#2E8F82"> string</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#59873A">  dirname</span><span style="color:#999999">(</span><span style="color:#B07D48">path</span><span style="color:#999999">: </span><span style="color:#2E8F82">string</span><span style="color:#999999">):</span><span style="color:#2E8F82"> string</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#B07D48">  sep</span><span style="color:#999999">: </span><span style="color:#2E8F82">string</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#999999">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959">declare</span><span style="color:#AB5959"> module</span><span style="color:#B5695977"> "</span><span style="color:#B56959">path</span><span style="color:#B5695977">"</span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#AB5959">  const </span><span style="color:#B07D48">path</span><span style="color:#999999">: </span><span style="color:#2E8F82">PathModule</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#1E754F">  export</span><span style="color:#1E754F"> default</span><span style="color:#B07D48"> path</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#999999">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#AB5959">declare</span><span style="color:#AB5959"> module</span><span style="color:#B5695977"> "</span><span style="color:#B56959">node:path</span><span style="color:#B5695977">"</span><span style="color:#999999"> {</span></span>
<span class="line"><span style="color:#AB5959">  const </span><span style="color:#B07D48">path</span><span style="color:#999999">: </span><span style="color:#2E8F82">PathModule</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#1E754F">  export</span><span style="color:#1E754F"> default</span><span style="color:#B07D48"> path</span><span style="color:#999999">;</span></span>
<span class="line"><span style="color:#999999">}</span></span>
<span class="line"></span></code></pre>10:["$","div",null,{"className":"min-w-0 max-w-full lg:justify-self-center","children":["$","div",null,{"className":"space-y-14","children":[["$","section",null,{"className":"space-y-6","children":[["$","div",null,{"className":"flex flex-wrap items-center gap-3","children":[["$","div",null,{"className":"inline-flex items-center rounded-full border px-3 py-1 text-[11px] font-semibold uppercase tracking-[0.08em] transition-colors border-border/70 bg-white/70 text-muted-foreground","children":"OpenCode ready"}],["$","div",null,{"className":"inline-flex items-center rounded-full border px-3 py-1 text-[11px] font-semibold uppercase tracking-[0.08em] transition-colors border-border/70 bg-white/70 text-muted-foreground","children":[1," ","variant"]}]]}],["$","div",null,{"className":"space-y-3","children":[["$","h1",null,{"className":"text-3xl font-semibold tracking-tight text-slate-900 sm:text-4xl","children":"Ralph Loop"}],["$","p",null,{"className":"text-lg text-muted-foreground","children":"Iterative loop for OpenCode that advances one step per run from a prompt file."}]]}],["$","section",null,{"id":"overview","className":"scroll-mt-24 space-y-6","children":["$","div",null,{"className":"markdown","children":"$L12"}]}]]}],["$","section",null,{"id":"install","className":"scroll-mt-24 space-y-6","children":[["$","div",null,{"className":"flex flex-wrap items-center justify-between gap-4","children":[["$","div",null,{"className":"space-y-2","children":[["$","p",null,{"className":"text-xs font-semibold uppercase tracking-[0.24em] text-muted-foreground","children":"Installation"}],["$","h2",null,{"className":"text-2xl font-semibold tracking-tight text-slate-900","children":"Install"}]]}],["$","div",null,{"className":"min-w-[220px]","children":["$","select",null,{"aria-label":"Platform","defaultValue":"opencode","className":"w-full rounded-xl border border-border/70 bg-white/80 px-3 py-2 text-sm font-medium text-foreground shadow-sm","children":[["$","option",null,{"value":"opencode","children":"OpenCode"}],["$","option",null,{"value":"claude","disabled":true,"children":"Claude Code (soon)"}],["$","option",null,{"value":"codex","disabled":true,"children":"Codex CLI (soon)"}]]}]}]]}],["$","div",null,{"className":"rounded-2xl border border-border/70 bg-white/80 p-6 shadow-sm","children":["$","$L13",null,{"opencodeVariant":{"$schema":"https://ui.shadcn.com/schema/registry-item.json","name":"ralph-loop-opencode","type":"registry:item","title":"OpenCode Ralph Loop","description":"Ralph loop agent, command, and plugin for OpenCode.","meta":{"concept":"ralph-loop","platform":"opencode","kind":["agent","command","plugin"],"installPath":"ralph-loop-opencode.v1.json"},"files":[{"path":"registry/ralph-loop/opencode/files/agent/ralph.md","type":"registry:file","target":"~/.opencode/agent/ralph.md"},{"path":"registry/ralph-loop/opencode/files/command/ralph.md","type":"registry:file","target":"~/.opencode/command/ralph.md"},{"path":"registry/ralph-loop/opencode/files/plugin/ralph-loop.ts","type":"registry:file","target":"~/.opencode/plugin/ralph-loop.ts"},{"path":"registry/ralph-loop/opencode/files/ralph/ralph-utils.ts","type":"registry:file","target":"~/.opencode/ralph/ralph-utils.ts"},{"path":"registry/ralph-loop/opencode/files/types/shims.d.ts","type":"registry:file","target":"~/.opencode/types/shims.d.ts"}],"docs":"Restart OpenCode after installing to register the /ralph command. Targets prefixed with ~ are repo-scoped (project-root) paths."},"installCommand":"npx shadcn@latest add https://brennanmceachran.github.io/agent-utils/ralph-loop-opencode.v1.json","installCommandHtml":"<pre class=\"shiki vitesse-light\" style=\"background-color:#ffffff;color:#393a34\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color:#59873A\">npx</span><span style=\"color:#B56959\"> shadcn@latest</span><span style=\"color:#B56959\"> add</span><span style=\"color:#B56959\"> https://brennanmceachran.github.io/agent-utils/ralph-loop-opencode.v1.json</span></span></code></pre>","codeBlocks":[{"id":"registry-ralph-loop-opencode-files-agent-ralph-md","label":"agent/ralph.md","path":"registry/ralph-loop/opencode/files/agent/ralph.md","target":"~/.opencode/agent/ralph.md","raw":"$14","html":"$15","language":"markdown"},{"id":"registry-ralph-loop-opencode-files-command-ralph-md","label":"command/ralph.md","path":"registry/ralph-loop/opencode/files/command/ralph.md","target":"~/.opencode/command/ralph.md","raw":"---\ndescription: Start/stop a Ralph loop on a prompt file\nagent: ralph\n---\n\nRALPH_CONTROL: {\"arg1\":\"$1\",\"arg2\":\"$2\",\"arg3\":\"$3\"}\n\nThis command sends a control message that the Ralph loop plugin listens for.\n\n- If `$1` is `stop`, stop the Ralph loop.\n- Otherwise, treat `$1` as the prompt file reference and `$2` as an optional max-iterations number.\n\nRespond with a brief acknowledgement only. Do not run tools in response to this control message.\n","html":"$16","language":"markdown"},{"id":"registry-ralph-loop-opencode-files-plugin-ralph-loop-ts","label":"plugin/ralph-loop.ts","path":"registry/ralph-loop/opencode/files/plugin/ralph-loop.ts","target":"~/.opencode/plugin/ralph-loop.ts","raw":"$17","html":"$18","language":"ts"},{"id":"registry-ralph-loop-opencode-files-ralph-ralph-utils-ts","label":"ralph/ralph-utils.ts","path":"registry/ralph-loop/opencode/files/ralph/ralph-utils.ts","target":"~/.opencode/ralph/ralph-utils.ts","raw":"$19","html":"$1a","language":"ts"},{"id":"registry-ralph-loop-opencode-files-types-shims-d-ts","label":"types/shims.d.ts","path":"registry/ralph-loop/opencode/files/types/shims.d.ts","target":"~/.opencode/types/shims.d.ts","raw":"$1b","html":"$1c","language":"ts"}]}]}]]}],"$L1d","$L1e","$L1f","$L20"]}]}]
11:["$","aside",null,{"className":"hidden xl:flex xl:flex-col xl:sticky xl:top-20 xl:h-[calc(100vh-6rem)] xl:justify-self-end xl:overflow-y-auto xl:pl-2","children":["$","div",null,{"className":"space-y-4","children":[["$","p",null,{"className":"text-xs font-semibold uppercase tracking-[0.24em] text-muted-foreground","children":"On this page"}],["$","nav",null,{"className":"space-y-2 text-sm text-muted-foreground","children":[["$","a","overview",{"href":"#overview","className":"block rounded-md px-2 py-1 transition hover:bg-muted/60 hover:text-foreground","children":"Overview"}],["$","a","install",{"href":"#install","className":"block rounded-md px-2 py-1 transition hover:bg-muted/60 hover:text-foreground","children":"Installation"}],["$","a","usage",{"href":"#usage","className":"block rounded-md px-2 py-1 transition hover:bg-muted/60 hover:text-foreground","children":"Usage"}],["$","a","examples",{"href":"#examples","className":"block rounded-md px-2 py-1 transition hover:bg-muted/60 hover:text-foreground","children":"Examples"}],["$","a","notes",{"href":"#notes","className":"block rounded-md px-2 py-1 transition hover:bg-muted/60 hover:text-foreground","children":"Notes"}]]}]]}]}]
1d:["$","section",null,{"className":"space-y-6","children":["$","div",null,{"ref":"$undefined","className":"rounded-2xl border border-border/70 text-card-foreground shadow-sm backdrop-blur bg-white/80","children":[["$","div",null,{"ref":"$undefined","className":"flex flex-col space-y-2 p-6","children":["$","h3",null,{"ref":"$undefined","className":"text-base font-semibold tracking-tight","children":"Quick start"}]}],["$","div",null,{"ref":"$undefined","className":"p-6 pt-0","children":["$","div",null,{"className":"markdown","children":[["$","p",null,{"children":["$","strong",null,{"children":"What this gives you"}]}],"\n",["$","ul",null,{"children":["\n",["$","li",null,{"children":"A bounded loop that advances one useful step per iteration."}],"\n",["$","li",null,{"children":"A progress log written back into the prompt file after each run."}],"\n",["$","li",null,{"children":"The ability to let an agent grind through the happy path for hours."}],"\n",["$","li",null,{"children":"Inspired by the Claude Code Ralph Wiggum loop technique."}],"\n"]}],"\n",["$","p",null,{"children":"I have run this for 4-5 hours on gpt-5.2-codex (extra high reasoning) without babysitting."}],"\n",["$","p",null,{"children":["$","strong",null,{"children":"Try it"}]}],"\n",["$","ol",null,{"children":["\n",["$","li",null,{"children":"Create a PRD file (template below)."}],"\n",["$","li",null,{"children":["Switch to the ",["$","strong",null,{"children":"Ralph"}]," agent and run:"]}],"\n"]}],"\n","$L21","\n",["$","ol",null,{"start":"3","children":["\n",["$","li",null,{"children":["Watch it work! The loop will continue until the agent responds with ",["$","code",null,{"children":"RALPH_DONE"}],", then re-run or you manually stop it ",["$","code",null,{"children":"/ralph stop"}],"."]}],"\n",["$","li",null,{"children":"???"}],"\n",["$","li",null,{"children":"Profit."}],"\n"]}]]}]}]]}]}]
1e:["$","section",null,{"id":"usage","className":"scroll-mt-24 space-y-6","children":[["$","div",null,{"className":"space-y-2","children":[["$","p",null,{"className":"text-xs font-semibold uppercase tracking-[0.24em] text-muted-foreground","children":"Usage"}],["$","h2",null,{"className":"text-2xl font-semibold tracking-tight text-slate-900","children":"How to use it well"}]]}],["$","div",null,{"ref":"$undefined","className":"rounded-2xl border border-border/70 bg-card/80 text-card-foreground shadow-sm backdrop-blur","children":["$","div",null,{"ref":"$undefined","className":"p-6 pt-6","children":["$","div",null,{"className":"markdown","children":[["$","h3",null,{"children":"1) Draft a PRD (validator-required sections)"}],"\n",["$","p",null,{"children":"Ralph validates the prompt file. These headings are required and must be non-empty:"}],"\n",["$","ul",null,{"children":["\n",["$","li",null,{"children":"Goal"}],"\n",["$","li",null,{"children":"Acceptance Criteria"}],"\n",["$","li",null,{"children":"Verification"}],"\n",["$","li",null,{"children":"Progress"}],"\n"]}],"\n",["$","p",null,{"children":"Below is a template. Copy it and fill it out replace with your details. Leave the Progress section alone."}],"\n","$L22","\n",["$","h3",null,{"children":"2) Set the model"}],"\n",["$","p",null,{"children":"Pick a model that can grind:"}],"\n",["$","ul",null,{"children":["\n",["$","li",null,{"children":"gpt-5.2-codex (extra high reasoning)"}],"\n",["$","li",null,{"children":"Opus 4.5"}],"\n"]}],"\n",["$","h3",null,{"children":"3) Switch to the Ralph agent"}],"\n",["$","p",null,{"children":["Tab through agents until the status reads ",["$","code",null,{"children":"ralph"}],"."]}],"\n",["$","h3",null,{"children":"4) Run the loop"}],"\n",["$","p",null,{"children":"The Ralph commands has two parameters:"}],"\n",["$","ol",null,{"children":["\n",["$","li",null,{"children":"The path to the PRD file"}],"\n",["$","li",null,{"children":"The max number of iterations to run (default 25)"}],"\n"]}],"\n",["$","p",null,{"children":"Start with 5 iterations until you get the hang of it:"}],"\n","$L23","\n",["$","p",null,{"children":"Then up as needed:"}],"\n","$L24","\n",["$","h3",null,{"children":"5) How the loop behaves"}],"\n",["$","p",null,{"children":["It will keep smashing your prompt back into the loop until it outputs ",["$","code",null,{"children":"RALPH_DONE"}]," or hits the max iteration cap. That is the point: run the happy path for hours without babysitting.\nEach iteration writes Progress back into the PRD. So the next turn picks up where the last left off."]}],"\n",["$","p",null,{"children":"The configs auto accept everything, but stop git push and attemp to stop any destructive actions."}],"\n",["$","h3",null,{"children":"6) Need to steer every once and a while?"}],"\n",["$","p",null,{"children":"Because this is in Opencode UI, you can interact with the loop while it's running."}],"\n",["$","p",null,{"children":"Just type a message and hit enter. OpenCode will insert it at the next available moment nudging the agent in the right direction."}],"\n",["$","p",null,{"children":["However, I find the models ",["$","em",null,{"children":"eventually"}]," get there so try to resist the urg."]}],"\n",["$","h3",null,{"children":"7) Stop the loop"}],"\n",["$","ul",null,{"children":["\n",["$","li",null,{"children":"Press Ctrl+C"}],"\n",["$","li",null,{"children":["Or run ",["$","code",null,{"children":"/ralph stop"}]]}],"\n"]}]]}]}]}]]}]
1f:["$","section",null,{"id":"examples","className":"scroll-mt-24 space-y-6","children":[["$","div",null,{"className":"space-y-2","children":[["$","p",null,{"className":"text-xs font-semibold uppercase tracking-[0.24em] text-muted-foreground","children":"Examples"}],["$","h2",null,{"className":"text-2xl font-semibold tracking-tight text-slate-900","children":"Shared runs"}]]}],["$","div",null,{"ref":"$undefined","className":"rounded-2xl border border-border/70 bg-card/80 text-card-foreground shadow-sm backdrop-blur","children":["$","div",null,{"ref":"$undefined","className":"p-6 pt-6","children":["$","div",null,{"className":"markdown","children":["$","table",null,{"children":[["$","thead",null,{"children":["$","tr",null,{"children":[["$","th",null,{"children":"Thread"}],["$","th",null,{"children":"Platform"}],["$","th",null,{"children":"What it shows"}],["$","th",null,{"children":"Link"}]]}]}],["$","tbody",null,{"children":["$","tr",null,{"children":[["$","td",null,{"children":"Summarizing RALPH_CONTROL loop control message"}],["$","td",null,{"children":"OpenCode"}],["$","td",null,{"children":"Loop run with progress updates and status tracking."}],["$","td",null,{"children":["$","a",null,{"href":"https://opncd.ai/share/M2rXLsAD","children":"Open thread"}]}]]}]}]]}]}]}]}]]}]
20:["$","section",null,{"id":"notes","className":"scroll-mt-24 space-y-6","children":[["$","div",null,{"className":"space-y-2","children":[["$","p",null,{"className":"text-xs font-semibold uppercase tracking-[0.24em] text-muted-foreground","children":"Notes"}],["$","h2",null,{"className":"text-2xl font-semibold tracking-tight text-slate-900","children":"Notes"}]]}],["$","div",null,{"ref":"$undefined","className":"rounded-2xl border border-border/70 bg-card/80 text-card-foreground shadow-sm backdrop-blur","children":["$","div",null,{"ref":"$undefined","className":"p-6 pt-6","children":["$","div",null,{"className":"markdown","children":["$","p",null,{"children":"Restart OpenCode after installing to register the /ralph command. Prefer file-based prompts (use @path) for long instructions and multi-line edits."}]}]}]}]]}]
21:["$","div",null,{"className":"mt-3 overflow-x-auto rounded-xl border border-border/60 bg-muted/40 p-4 text-xs text-foreground","children":["$","div",null,{"className":"text-[13px]","children":["$","pre",null,{"className":"shiki vitesse-light","style":{"backgroundColor":"#ffffff","color":"#393a34"},"tabIndex":"0","children":["$","code",null,{"children":["$","span",null,{"className":"line","children":[["$","span","0",{"style":{"color":"#59873A"},"children":"/ralph"}],["$","span","1",{"style":{"color":"#B56959"},"children":" @docs/feature-x.prd.md"}],["$","span","2",{"style":{"color":"#2F798A"},"children":" 10"}]]}]}]}]}]}]
22:["$","div",null,{"className":"mt-3 overflow-x-auto rounded-xl border border-border/60 bg-muted/40 p-4 text-xs text-foreground","children":["$","div",null,{"className":"text-[13px]","children":["$","pre",null,{"className":"shiki vitesse-light","style":{"backgroundColor":"#ffffff","color":"#393a34"},"tabIndex":"0","children":["$","code",null,{"children":[["$","span","0",{"className":"line","children":[["$","span","0",{"style":{"color":"#999999","fontWeight":"bold"},"children":"#"}],["$","span","1",{"style":{"color":"#1C6B48","fontWeight":"bold"},"children":" PRD: <Feature name>"}]]}],"\n",["$","span","2",{"className":"line","children":"$undefined"}],"\n",["$","span","4",{"className":"line","children":[["$","span","0",{"style":{"color":"#999999","fontWeight":"bold"},"children":"##"}],["$","span","1",{"style":{"color":"#1C6B48","fontWeight":"bold"},"children":" TL;DR"}]]}],"\n",["$","span","6",{"className":"line","children":"$undefined"}],"\n",["$","span","8",{"className":"line","children":[["$","span","0",{"style":{"color":"#A65E2B"},"children":"-"}],["$","span","1",{"style":{"color":"#393A34"},"children":" One sentence: what are we shipping?"}]]}],"\n",["$","span","10",{"className":"line","children":"$undefined"}],"\n",["$","span","12",{"className":"line","children":[["$","span","0",{"style":{"color":"#999999","fontWeight":"bold"},"children":"##"}],["$","span","1",{"style":{"color":"#1C6B48","fontWeight":"bold"},"children":" Goal"}]]}],"\n",["$","span","14",{"className":"line","children":"$undefined"}],"\n",["$","span","16",{"className":"line","children":[["$","span","0",{"style":{"color":"#A65E2B"},"children":"-"}],["$","span","1",{"style":{"color":"#393A34"},"children":" What outcome should exist when done?"}]]}],"\n",["$","span","18",{"className":"line","children":"$undefined"}],"\n",["$","span","20",{"className":"line","children":[["$","span","0",{"style":{"color":"#999999","fontWeight":"bold"},"children":"##"}],["$","span","1",{"style":{"color":"#1C6B48","fontWeight":"bold"},"children":" Constraints"}]]}],"\n",["$","span","22",{"className":"line","children":"$undefined"}],"\n",["$","span","24",{"className":"line","children":[["$","span","0",{"style":{"color":"#A65E2B"},"children":"-"}],["$","span","1",{"style":{"color":"#393A34"},"children":" Tech constraints, deadlines, guardrails."}]]}],"\n",["$","span","26",{"className":"line","children":"$undefined"}],"\n",["$","span","28",{"className":"line","children":[["$","span","0",{"style":{"color":"#999999","fontWeight":"bold"},"children":"##"}],["$","span","1",{"style":{"color":"#1C6B48","fontWeight":"bold"},"children":" Acceptance Criteria"}]]}],"\n",["$","span","30",{"className":"line","children":"$undefined"}],"\n",["$","span","32",{"className":"line","children":[["$","span","0",{"style":{"color":"#A65E2B"},"children":"-"}],["$","span","1",{"style":{"color":"#393A34"},"children":" [ ] Observable success conditions"}]]}],"\n",["$","span","34",{"className":"line","children":[["$","span","0",{"style":{"color":"#A65E2B"},"children":"-"}],["$","span","1",{"style":{"color":"#393A34"},"children":" [ ] Edge cases you care about"}]]}],"\n",["$","span","36",{"className":"line","children":"$undefined"}],"\n",["$","span","38",{"className":"line","children":[["$","span","0",{"style":{"color":"#999999","fontWeight":"bold"},"children":"##"}],["$","span","1",{"style":{"color":"#1C6B48","fontWeight":"bold"},"children":" Verification"}]]}],"\n",["$","span","40",{"className":"line","children":"$undefined"}],"\n",["$","span","42",{"className":"line","children":[["$","span","0",{"style":{"color":"#A65E2B"},"children":"-"}],["$","span","1",{"style":{"color":"#393A34"},"children":" Tests or manual checks that prove it works"}]]}],"\n",["$","span","44",{"className":"line","children":"$undefined"}],"\n",["$","span","46",{"className":"line","children":[["$","span","0",{"style":{"color":"#999999","fontWeight":"bold"},"children":"##"}],["$","span","1",{"style":{"color":"#1C6B48","fontWeight":"bold"},"children":" Notes"}]]}],"\n",["$","span","48",{"className":"line","children":"$undefined"}],"\n",["$","span","50",{"className":"line","children":[["$","span","0",{"style":{"color":"#A65E2B"},"children":"-"}],["$","span","1",{"style":{"color":"#393A34"},"children":" Anything the loop should remember each iteration"}]]}],"\n",["$","span","52",{"className":"line","children":"$undefined"}],"\n",["$","span","54",{"className":"line","children":[["$","span","0",{"style":{"color":"#999999","fontWeight":"bold"},"children":"##"}],["$","span","1",{"style":{"color":"#1C6B48","fontWeight":"bold"},"children":" Progress"}]]}],"\n",["$","span","56",{"className":"line","children":"$undefined"}],"\n",["$","span","58",{"className":"line","children":["$","span",null,{"style":{"color":"#393A34"},"children":"It's your job to update the progress field every time you make a change. The purpose of this is to ensure the next developer knows what you did, what's done, any decisions or assumptions you made, and is able to continue working. If you've made changes, please copy and paste this template to the bottom of the progress and edit to add your notes."}]}],"\n","$L25","\n","$L26","\n","$L27","\n","$L28","\n","$L29","\n","$L2a","\n","$L2b","\n","$L2c","\n","$L2d","\n","$L2e","\n","$L2f","\n","$L30","\n","$L31","\n","$L32","\n","$L33"]}]}]}]}]
23:["$","div",null,{"className":"mt-3 overflow-x-auto rounded-xl border border-border/60 bg-muted/40 p-4 text-xs text-foreground","children":["$","div",null,{"className":"text-[13px]","children":["$","pre",null,{"className":"shiki vitesse-light","style":{"backgroundColor":"#ffffff","color":"#393a34"},"tabIndex":"0","children":["$","code",null,{"children":["$","span",null,{"className":"line","children":[["$","span","0",{"style":{"color":"#59873A"},"children":"/ralph"}],["$","span","1",{"style":{"color":"#B56959"},"children":" @docs/feature-x.prd.md"}],["$","span","2",{"style":{"color":"#2F798A"},"children":" 5"}]]}]}]}]}]}]
24:["$","div",null,{"className":"mt-3 overflow-x-auto rounded-xl border border-border/60 bg-muted/40 p-4 text-xs text-foreground","children":["$","div",null,{"className":"text-[13px]","children":["$","pre",null,{"className":"shiki vitesse-light","style":{"backgroundColor":"#ffffff","color":"#393a34"},"tabIndex":"0","children":["$","code",null,{"children":["$","span",null,{"className":"line","children":[["$","span","0",{"style":{"color":"#59873A"},"children":"/ralph"}],["$","span","1",{"style":{"color":"#B56959"},"children":" @docs/feature-x.prd.md"}],["$","span","2",{"style":{"color":"#2F798A"},"children":" 50"}]]}]}]}]}]}]
34:I[57084,["/agent-utils/_next/static/chunks/88049d1610f79db3.js","/agent-utils/_next/static/chunks/122bbe670a0c62fe.js","/agent-utils/_next/static/chunks/28ac2bf59af5b750.js"],"TweetActionsRow"]
25:["$","span","60",{"className":"line","children":"$undefined"}]
26:["$","span","62",{"className":"line","children":[["$","span","0",{"style":{"color":"#999999"},"children":"```"}],["$","span","1",{"style":{"color":"#393A34"},"children":"template"}]]}]
27:["$","span","64",{"className":"line","children":["$","span",null,{"style":{"color":"#393A34"},"children":"### {{Title}} - {{Date}}"}]}]
28:["$","span","66",{"className":"line","children":"$undefined"}]
29:["$","span","68",{"className":"line","children":["$","span",null,{"style":{"color":"#393A34"},"children":"- {{Summary}}"}]}]
2a:["$","span","70",{"className":"line","children":["$","span",null,{"style":{"color":"#393A34"},"children":"- {{Decisions}}"}]}]
2b:["$","span","72",{"className":"line","children":["$","span",null,{"style":{"color":"#393A34"},"children":"- {{Assumptions}}"}]}]
2c:["$","span","74",{"className":"line","children":["$","span",null,{"style":{"color":"#393A34"},"children":"- {{Risks}}"}]}]
2d:["$","span","76",{"className":"line","children":["$","span",null,{"style":{"color":"#393A34"},"children":"- {{Status}}"}]}]
2e:["$","span","78",{"className":"line","children":["$","span",null,{"style":{"color":"#393A34"},"children":"- Best guess at what comes next & why:"}]}]
2f:["$","span","80",{"className":"line","children":["$","span",null,{"style":{"color":"#393A34"},"children":"  - {{Next}}"}]}]
30:["$","span","82",{"className":"line","children":["$","span",null,{"style":{"color":"#393A34"},"children":"  - {{Next?}}"}]}]
31:["$","span","84",{"className":"line","children":["$","span",null,{"style":{"color":"#999999"},"children":"```"}]}]
32:["$","span","86",{"className":"line","children":"$undefined"}]
33:["$","span","88",{"className":"line","children":["$","span",null,{"style":{"color":"#393A34"},"children":"Add entries below this line:"}]}]
12:["$","div",null,{"className":"overflow-hidden rounded-2xl border border-border/70 bg-card/80 shadow-sm backdrop-blur","children":[["$","div",null,{"className":"relative w-full bg-slate-950","style":{"aspectRatio":"16 / 9"},"children":["$","video",null,{"className":"h-full w-full object-contain","controls":true,"playsInline":true,"preload":"metadata","poster":"https://pbs.twimg.com/amplify_video_thumb/2008553648259833857/img/jCIcCvbMkveN3wem.jpg","aria-label":"Tweet video","crossOrigin":"anonymous","children":[["$","source",null,{"src":"https://video.twimg.com/amplify_video/2008553648259833857/vid/avc1/1920x1080/1iXg1c3O9Kfy8nqX.mp4","type":"video/mp4"}],["$","track",null,{"kind":"captions","srcLang":"en","label":"English","src":"data:text/vtt,WEBVTT"}]]}]}],["$","div",null,{"className":"bg-card/80 px-6 py-4 border-t border-border/70","children":[["$","div",null,{"className":"relative","children":[["$","p",null,{"className":"pr-16 text-sm leading-snug text-slate-700","style":{"display":"-webkit-box","WebkitLineClamp":2,"WebkitBoxOrient":"vertical","overflow":"hidden"},"children":[["$","span","text-0-18",{"children":"Ralph achieved in "}],["$","a","mention-18-27",{"href":"https://x.com/opencode","target":"_blank","rel":"noreferrer","className":"font-medium text-slate-700 underline decoration-transparent underline-offset-2 transition hover:text-slate-900 hover:decoration-slate-300","children":"@opencode"}],["$","span","text-27-278",{"children":"! Running a Ralph loop right now to Migrate DB and ORMs on GPT-5.2-extra-high thinking\n\nA ralph agent, /command, plugin (for stop events and notifications), a linter on the prompt file, + extra security so it accepts basically everything except overly"}]]}],["$","a",null,{"href":"https://x.com/i_am_brennan/status/2008554594029240467","target":"_blank","rel":"noreferrer","className":"absolute bottom-0 right-1 z-10 whitespace-nowrap rounded-full bg-card/95 px-1.5 py-0.5 text-[0.7rem] font-medium text-muted-foreground shadow-sm transition hover:text-foreground","children":"Show more"}]]}],["$","$L34",null,{"tweetUrl":"https://x.com/i_am_brennan/status/2008554594029240467","likeUrl":"https://x.com/intent/like?tweet_id=2008554594029240467","replyUrl":"https://x.com/intent/tweet?in_reply_to=2008554594029240467","likeCount":7,"user":{"id_str":"36600404","name":"Brennan McEachran ","screen_name":"i_am_brennan","is_blue_verified":true,"profile_image_shape":"Circle","verified":false,"profile_image_url_https":"https://pbs.twimg.com/profile_images/1909611582146912256/7YHaoXM8_normal.png","url":"https://x.com/i_am_brennan","follow_url":"https://x.com/intent/follow?screen_name=i_am_brennan"},"className":"mt-3"}]]}]]}]
b:[["$","title","0",{"children":"Ralph Loop | Agent Utils Registry"}],["$","meta","1",{"name":"description","content":"Iterative loop for OpenCode that advances one step per run from a prompt file."}],["$","meta","2",{"name":"referrer","content":"no-referrer"}],["$","link","3",{"rel":"canonical","href":"https://brennanmceachran.github.io/registry/ralph-loop/"}],["$","meta","4",{"property":"og:title","content":"Ralph Loop | Agent Utils"}],["$","meta","5",{"property":"og:description","content":"Iterative loop for OpenCode that advances one step per run from a prompt file."}],["$","meta","6",{"property":"og:url","content":"https://brennanmceachran.github.io/agent-utils/registry/ralph-loop/"}],["$","meta","7",{"property":"og:image","content":"https://pbs.twimg.com/amplify_video_thumb/2008553648259833857/img/jCIcCvbMkveN3wem.jpg"}],["$","meta","8",{"property":"og:image","content":"https://brennanmceachran.github.io/agent-utils/registry/ralph-loop/opengraph-image.png"}],["$","meta","9",{"property":"og:video","content":"https://video.twimg.com/amplify_video/2008553648259833857/vid/avc1/1920x1080/1iXg1c3O9Kfy8nqX.mp4"}],["$","meta","10",{"property":"og:video:type","content":"video/mp4"}],["$","meta","11",{"property":"og:type","content":"article"}],["$","meta","12",{"name":"twitter:card","content":"summary_large_image"}],["$","meta","13",{"name":"twitter:title","content":"Ralph Loop | Agent Utils"}],["$","meta","14",{"name":"twitter:description","content":"Iterative loop for OpenCode that advances one step per run from a prompt file."}],["$","meta","15",{"name":"twitter:image","content":"https://pbs.twimg.com/amplify_video_thumb/2008553648259833857/img/jCIcCvbMkveN3wem.jpg"}],["$","meta","16",{"name":"twitter:image","content":"https://brennanmceachran.github.io/agent-utils/registry/ralph-loop/opengraph-image.png"}]]
7:null
